<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-soul-http-client-register" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-http-client-register/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.769Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="soul-http-client-注册流程"><a href="#soul-http-client-注册流程" class="headerlink" title="soul http client 注册流程"></a>soul http client 注册流程</h4><p>spring mvc应用端配置soul注册信息</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">soul:</span></span><br><span class="line">  <span class="attr">http:</span></span><br><span class="line">    <span class="attr">adminUrl:</span> <span class="string">http://localhost:9095</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8188</span></span><br><span class="line">    <span class="attr">contextPath:</span> <span class="string">/http</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">full:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>soul-spring-boot-starter-client-springmvc启动的时候注册SpringMvcClientBeanPostProcessor后置处理器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SoulSpringMvcClientConfiguration</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注册SpringMvcClientBeanPostProcessor后置处理器</span></span><br><span class="line"><span class="comment">     * Spring http client bean post processor spring http client bean post processor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> soulSpringMvcConfig the soul http config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the spring http client bean post processor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SpringMvcClientBeanPostProcessor <span class="title">springHttpClientBeanPostProcessor</span><span class="params">(<span class="keyword">final</span> SoulSpringMvcConfig soulSpringMvcConfig)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringMvcClientBeanPostProcessor(soulSpringMvcConfig);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 读取应用端配置</span></span><br><span class="line"><span class="comment">     * Soul http config soul http config.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the soul http config</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;soul.http&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SoulSpringMvcConfig <span class="title">soulHttpConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SoulSpringMvcConfig();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SpringMvcClientBeanPostProcessor后置处理器进行Bean扫描并提交注册任务到线程池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringMvcClientBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadPoolExecutor executorService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String url;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SoulSpringMvcConfig soulSpringMvcConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、校验配置是否合法</span></span><br><span class="line"><span class="comment">     * 2、实例化一个线程池,后续用来多线程注册代理接口</span></span><br><span class="line"><span class="comment">     * Instantiates a new Soul client bean post processor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> soulSpringMvcConfig the soul spring mvc config</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SpringMvcClientBeanPostProcessor</span><span class="params">(<span class="keyword">final</span> SoulSpringMvcConfig soulSpringMvcConfig)</span> </span>&#123;</span><br><span class="line">        ValidateUtils.validate(soulSpringMvcConfig);</span><br><span class="line">        <span class="keyword">this</span>.soulSpringMvcConfig = soulSpringMvcConfig;</span><br><span class="line">        url = soulSpringMvcConfig.getAdminUrl() + <span class="string">&quot;/soul-client/springmvc-register&quot;</span>;</span><br><span class="line">        executorService = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、扫描配置</span></span><br><span class="line"><span class="comment">     * 2、注册代理接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> Object bean, <span class="meta">@NonNull</span> <span class="keyword">final</span> String beanName)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="comment">// isFull = true 表示代理整个应用，isFull = false 表示只代理一部分</span></span><br><span class="line">        <span class="keyword">if</span> (soulSpringMvcConfig.isFull()) &#123;</span><br><span class="line">            <span class="keyword">return</span> bean;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 扫描Controller注解</span></span><br><span class="line">        Controller controller = AnnotationUtils.findAnnotation(bean.getClass(), Controller.class);</span><br><span class="line">        <span class="comment">// 扫描RestController注解</span></span><br><span class="line">        RestController restController = AnnotationUtils.findAnnotation(bean.getClass(), RestController.class);</span><br><span class="line">        <span class="comment">// 扫描RequestMapping注解</span></span><br><span class="line">        RequestMapping requestMapping = AnnotationUtils.findAnnotation(bean.getClass(), RequestMapping.class);</span><br><span class="line">        <span class="keyword">if</span> (controller != <span class="keyword">null</span> || restController != <span class="keyword">null</span> || requestMapping != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 扫描xxController类上SoulSpringMvcClient注解</span></span><br><span class="line">            SoulSpringMvcClient clazzAnnotation = AnnotationUtils.findAnnotation(bean.getClass(), SoulSpringMvcClient.class);</span><br><span class="line">            String prePath = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (Objects.nonNull(clazzAnnotation)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (clazzAnnotation.path().indexOf(<span class="string">&quot;*&quot;</span>) &gt; <span class="number">1</span>) &#123;</span><br><span class="line">                    String finalPrePath = prePath;</span><br><span class="line">                    <span class="comment">// 提交注册任务到线程池,由线程池请求soul-admin进行注册</span></span><br><span class="line">                    executorService.execute(() -&gt; RegisterUtils.doRegister(buildJsonParams(clazzAnnotation, finalPrePath), url,</span><br><span class="line">                            RpcTypeEnum.HTTP));</span><br><span class="line">                    <span class="keyword">return</span> bean;</span><br><span class="line">                &#125;</span><br><span class="line">                prePath = clazzAnnotation.path();</span><br><span class="line">            &#125;</span><br><span class="line">  </span><br><span class="line">            <span class="keyword">final</span> Method[] methods = ReflectionUtils.getUniqueDeclaredMethods(bean.getClass());</span><br><span class="line">            <span class="keyword">for</span> (Method method : methods) &#123;</span><br><span class="line">                <span class="comment">// 扫描xxController方法上的SoulSpringMvcClient注解</span></span><br><span class="line">                SoulSpringMvcClient soulSpringMvcClient = AnnotationUtils.findAnnotation(method, SoulSpringMvcClient.class);</span><br><span class="line">                <span class="keyword">if</span> (Objects.nonNull(soulSpringMvcClient)) &#123;</span><br><span class="line">                    String finalPrePath = prePath;</span><br><span class="line">                    <span class="comment">// 提交注册任务到线程池,由线程池请求soul-admin进行注册</span></span><br><span class="line">                    executorService.execute(() -&gt; RegisterUtils.doRegister(buildJsonParams(soulSpringMvcClient, finalPrePath), url,</span><br><span class="line">                            RpcTypeEnum.HTTP));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终委托给了RegisterUtils工具类通过OkHttpTools发送http请求注册到了soul-admin</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RegisterUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">RegisterUtils</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * call register api.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> json        request body</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url         url</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> rpcTypeEnum rcp type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">(<span class="keyword">final</span> String json, <span class="keyword">final</span> String url, <span class="keyword">final</span> RpcTypeEnum rpcTypeEnum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String result = OkHttpTools.getInstance().post(url, json);</span><br><span class="line">            <span class="keyword">if</span> (AdminConstants.SUCCESS.equals(result)) &#123;</span><br><span class="line">                log.info(<span class="string">&quot;&#123;&#125; client register success: &#123;&#125; &quot;</span>, rpcTypeEnum.getName(), json);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                log.error(<span class="string">&quot;&#123;&#125; client register error: &#123;&#125; &quot;</span>, rpcTypeEnum.getName(), json);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;cannot register soul admin param, url: &#123;&#125;, request body: &#123;&#125;&quot;</span>, url, json, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此，http方式注册就算完成。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-http-client-register/" data-id="ckn5dfeo10004qkvnc2zd5b71" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-global-plugin" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-global-plugin/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.758Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>soul global plugin是做什么的呢？这个官方文档里面没有提及，其实是因为这个插件是个面向开发的这么一个插件。那么它具体有什么作用呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalPlugin</span> <span class="keyword">implements</span> <span class="title">SoulPlugin</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SoulContextBuilder builder;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiates a new Global plugin.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> builder the builder</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GlobalPlugin</span><span class="params">(<span class="keyword">final</span> SoulContextBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.builder = builder;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">execute</span><span class="params">(<span class="keyword">final</span> ServerWebExchange exchange, <span class="keyword">final</span> SoulPluginChain chain)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        <span class="keyword">final</span> HttpHeaders headers = request.getHeaders();</span><br><span class="line">        <span class="keyword">final</span> String upgrade = headers.getFirst(<span class="string">&quot;Upgrade&quot;</span>);</span><br><span class="line">        SoulContext soulContext;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(upgrade) || !<span class="string">&quot;websocket&quot;</span>.equals(upgrade)) &#123;</span><br><span class="line">            soulContext = builder.build(exchange);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> MultiValueMap&lt;String, String&gt; queryParams = request.getQueryParams();</span><br><span class="line">            soulContext = transformMap(queryParams);</span><br><span class="line">        &#125;</span><br><span class="line">        exchange.getAttributes().put(Constants.CONTEXT, soulContext);</span><br><span class="line">        <span class="keyword">return</span> chain.execute(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> SoulContext <span class="title">transformMap</span><span class="params">(<span class="keyword">final</span> MultiValueMap&lt;String, String&gt; queryParams)</span> </span>&#123;</span><br><span class="line">        SoulContext soulContext = <span class="keyword">new</span> SoulContext();</span><br><span class="line">        soulContext.setModule(queryParams.getFirst(Constants.MODULE));</span><br><span class="line">        soulContext.setMethod(queryParams.getFirst(Constants.METHOD));</span><br><span class="line">        soulContext.setRpcType(queryParams.getFirst(Constants.RPC_TYPE));</span><br><span class="line">        <span class="keyword">return</span> soulContext;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">named</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;global&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面的代码可以看到，其实现了SoulPlugin接口，是个标准的插件，可以直接加到职责链中运行。做的事情就是构造一个上下文对象SoulContext。因为SoulContext的参数很多，所以使用了建造者模式，委托给了一个DefaultSoulContextBuilder去构造。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSoulContextBuilder</span> <span class="keyword">implements</span> <span class="title">SoulContextBuilder</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SoulContext <span class="title">build</span><span class="params">(<span class="keyword">final</span> ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> ServerHttpRequest request = exchange.getRequest();</span><br><span class="line">        String path = request.getURI().getPath();</span><br><span class="line">        MetaData metaData = MetaDataCache.getInstance().obtain(path);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(metaData) &amp;&amp; metaData.getEnabled()) &#123;</span><br><span class="line">            exchange.getAttributes().put(Constants.META_DATA, metaData);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> transform(request, metaData);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ServerHttpRequest transform RequestDTO .</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request &#123;<span class="doctag">@linkplain</span> ServerHttpRequest&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> RequestDTO request dto</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> SoulContext <span class="title">transform</span><span class="params">(<span class="keyword">final</span> ServerHttpRequest request, <span class="keyword">final</span> MetaData metaData)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String appKey = request.getHeaders().getFirst(Constants.APP_KEY);</span><br><span class="line">        <span class="keyword">final</span> String sign = request.getHeaders().getFirst(Constants.SIGN);</span><br><span class="line">        <span class="keyword">final</span> String timestamp = request.getHeaders().getFirst(Constants.TIMESTAMP);</span><br><span class="line">        SoulContext soulContext = <span class="keyword">new</span> SoulContext();</span><br><span class="line">        String path = request.getURI().getPath();</span><br><span class="line">        soulContext.setPath(path);</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(metaData) &amp;&amp; metaData.getEnabled()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (RpcTypeEnum.SPRING_CLOUD.getName().equals(metaData.getRpcType())) &#123;</span><br><span class="line">                setSoulContextByHttp(soulContext, path);</span><br><span class="line">                soulContext.setRpcType(metaData.getRpcType());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) &#123;</span><br><span class="line">                setSoulContextByDubbo(soulContext, metaData);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RpcTypeEnum.SOFA.getName().equals(metaData.getRpcType())) &#123;</span><br><span class="line">                setSoulContextBySofa(soulContext, metaData);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RpcTypeEnum.TARS.getName().equals(metaData.getRpcType())) &#123;</span><br><span class="line">                setSoulContextByTars(soulContext, metaData);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                setSoulContextByHttp(soulContext, path);</span><br><span class="line">                soulContext.setRpcType(RpcTypeEnum.HTTP.getName());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setSoulContextByHttp(soulContext, path);</span><br><span class="line">            soulContext.setRpcType(RpcTypeEnum.HTTP.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        soulContext.setAppKey(appKey);</span><br><span class="line">        soulContext.setSign(sign);</span><br><span class="line">        soulContext.setTimestamp(timestamp);</span><br><span class="line">        soulContext.setStartDateTime(LocalDateTime.now());</span><br><span class="line">        Optional.ofNullable(request.getMethod()).ifPresent(httpMethod -&gt; soulContext.setHttpMethod(httpMethod.name()));</span><br><span class="line">        <span class="keyword">return</span> soulContext;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setSoulContextByDubbo</span><span class="params">(<span class="keyword">final</span> SoulContext soulContext, <span class="keyword">final</span> MetaData metaData)</span> </span>&#123;</span><br><span class="line">        soulContext.setModule(metaData.getAppName());</span><br><span class="line">        soulContext.setMethod(metaData.getServiceName());</span><br><span class="line">        soulContext.setRpcType(metaData.getRpcType());</span><br><span class="line">        soulContext.setContextPath(metaData.getContextPath());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setSoulContextBySofa</span><span class="params">(<span class="keyword">final</span> SoulContext soulContext, <span class="keyword">final</span> MetaData metaData)</span> </span>&#123;</span><br><span class="line">        soulContext.setModule(metaData.getAppName());</span><br><span class="line">        soulContext.setMethod(metaData.getServiceName());</span><br><span class="line">        soulContext.setRpcType(metaData.getRpcType());</span><br><span class="line">        soulContext.setContextPath(metaData.getContextPath());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setSoulContextByTars</span><span class="params">(<span class="keyword">final</span> SoulContext soulContext, <span class="keyword">final</span> MetaData metaData)</span> </span>&#123;</span><br><span class="line">        soulContext.setModule(metaData.getServiceName());</span><br><span class="line">        soulContext.setMethod(metaData.getMethodName());</span><br><span class="line">        soulContext.setRpcType(metaData.getRpcType());</span><br><span class="line">        soulContext.setContextPath(metaData.getContextPath());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setSoulContextByHttp</span><span class="params">(<span class="keyword">final</span> SoulContext soulContext, <span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">        String contextPath = <span class="string">&quot;/&quot;</span>;</span><br><span class="line">        String[] splitList = StringUtils.split(path, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (splitList.length != <span class="number">0</span>) &#123;</span><br><span class="line">            contextPath = contextPath.concat(splitList[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        String realUrl = path.substring(contextPath.length());</span><br><span class="line">        soulContext.setContextPath(contextPath);</span><br><span class="line">        soulContext.setModule(contextPath);</span><br><span class="line">        soulContext.setMethod(realUrl);</span><br><span class="line">        soulContext.setRealUrl(realUrl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Global插件作为第一个运行的插件，会从请求ServerWebExchange对象中取出SoulContext所需要的信息存入SoulContext中，如果有元数据也一应放入。最终放入到ServerWebExchange属性中取名为context，往下透传。这是一种上下文设计模式。spring中各种context都是如此。</p>
<h2 id="关于Global插件代码一点思考"><a href="#关于Global插件代码一点思考" class="headerlink" title="关于Global插件代码一点思考"></a>关于Global插件代码一点思考</h2><ol>
<li>这段if-else逻辑可以优化掉</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SoulContext <span class="title">transform</span><span class="params">(<span class="keyword">final</span> ServerHttpRequest request, <span class="keyword">final</span> MetaData metaData)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String appKey = request.getHeaders().getFirst(Constants.APP_KEY);</span><br><span class="line">    <span class="keyword">final</span> String sign = request.getHeaders().getFirst(Constants.SIGN);</span><br><span class="line">    <span class="keyword">final</span> String timestamp = request.getHeaders().getFirst(Constants.TIMESTAMP);</span><br><span class="line">    SoulContext soulContext = <span class="keyword">new</span> SoulContext();</span><br><span class="line">    String path = request.getURI().getPath();</span><br><span class="line">    soulContext.setPath(path);</span><br><span class="line">    <span class="keyword">if</span> (Objects.nonNull(metaData) &amp;&amp; metaData.getEnabled()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (RpcTypeEnum.SPRING_CLOUD.getName().equals(metaData.getRpcType())) &#123;</span><br><span class="line">            setSoulContextByHttp(soulContext, path);</span><br><span class="line">            soulContext.setRpcType(metaData.getRpcType());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RpcTypeEnum.DUBBO.getName().equals(metaData.getRpcType())) &#123;</span><br><span class="line">            setSoulContextByDubbo(soulContext, metaData);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RpcTypeEnum.SOFA.getName().equals(metaData.getRpcType())) &#123;</span><br><span class="line">            setSoulContextBySofa(soulContext, metaData);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (RpcTypeEnum.TARS.getName().equals(metaData.getRpcType())) &#123;</span><br><span class="line">            setSoulContextByTars(soulContext, metaData);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            setSoulContextByHttp(soulContext, path);</span><br><span class="line">            soulContext.setRpcType(RpcTypeEnum.HTTP.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setSoulContextByHttp(soulContext, path);</span><br><span class="line">        soulContext.setRpcType(RpcTypeEnum.HTTP.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    soulContext.setAppKey(appKey);</span><br><span class="line">    soulContext.setSign(sign);</span><br><span class="line">    soulContext.setTimestamp(timestamp);</span><br><span class="line">    soulContext.setStartDateTime(LocalDateTime.now());</span><br><span class="line">    Optional.ofNullable(request.getMethod()).ifPresent(httpMethod -&gt; soulContext.setHttpMethod(httpMethod.name()));</span><br><span class="line">    <span class="keyword">return</span> soulContext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>SoulContext构造有点分散，是否都放入建造者中处理会集中一些</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-global-plugin/" data-id="ckn5dfeo10003qkvn71a1fbyy" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-dubbo-run" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-dubbo-run/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.745Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>soul 作为流行的网关应用，对接的系统各种各样，当然少不了dubbo。那么soul是如何对接dubbo应用的呢？那么，我们就先跑个例子看看。</p>
<ul>
<li>首先我们先启动soul网关和admin管理端</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2021-01-15 20:11:58.565  INFO 2644 --- [           main] o.d.s.w.configuration.SoulConfiguration  : load plugin:[alibaba-dubbo-body-param] [org.dromara.soul.plugin.alibaba.dubbo.param.BodyParamPlugin]</span><br><span class="line">2021-01-15 20:11:58.565  INFO 2644 --- [           main] o.d.s.w.configuration.SoulConfiguration  : load plugin:[dubbo] [org.dromara.soul.plugin.alibaba.dubbo.AlibabaDubboPlugin]</span><br><span class="line">2021-01-15 20:11:58.565  INFO 2644 --- [           main] o.d.s.w.configuration.SoulConfiguration  : load plugin:[monitor] [org.dromara.soul.plugin.monitor.MonitorPlugin]</span><br><span class="line">2021-01-15 20:11:58.565  INFO 2644 --- [           main] o.d.s.w.configuration.SoulConfiguration  : load plugin:[response] [org.dromara.soul.plugin.httpclient.response.WebClientResponsePlugin]</span><br><span class="line">2021-01-15 20:11:58.565  INFO 2644 --- [           main] o.d.s.w.configuration.SoulConfiguration  : load plugin:[response] [org.dromara.soul.plugin.alibaba.dubbo.response.DubboResponsePlugin]</span><br><span class="line">2021-01-15 20:11:58.783  INFO 2644 --- [           main] b.s.s.d.w.WebsocketSyncDataConfiguration : you use websocket sync soul data.......</span><br><span class="line">2021-01-15 20:11:58.965  INFO 2644 --- [           main] o.d.s.p.s.d.w.WebsocketSyncDataService   : websocket connection is successful.....</span><br><span class="line">2021-01-15 20:11:59.125  INFO 2644 --- [           main] o.s.b.a.e.web.EndpointLinksResolver      : Exposing 2 endpoint(s) beneath base path &#39;&#x2F;actuator&#39;</span><br><span class="line">2021-01-15 20:12:00.178  INFO 2644 --- [           main] o.s.b.web.embedded.netty.NettyWebServer  : Netty started on port(s): 9195</span><br><span class="line">2021-01-15 20:12:00.182  INFO 2644 --- [           main] o.d.s.b.SoulBootstrapApplication         : Started SoulBootstrapApplication in 8.658 seconds (JVM running for 10.543)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2021-01-15 20:10:15.679  INFO 9984 --- [           main] .d.s.w.r.o.CachingOperationNameGenerator : Generating unique operation named: batchEnabledUsingPOST_1</span><br><span class="line">2021-01-15 20:10:15.694  INFO 9984 --- [           main] .d.s.w.r.o.CachingOperationNameGenerator : Generating unique operation named: syncDataUsingPOST_1</span><br><span class="line">2021-01-15 20:10:15.725  INFO 9984 --- [           main] .d.s.w.r.o.CachingOperationNameGenerator : Generating unique operation named: detailRuleUsingGET_1</span><br><span class="line">2021-01-15 20:10:15.741  INFO 9984 --- [           main] .d.s.w.r.o.CachingOperationNameGenerator : Generating unique operation named: batchEnabledUsingPOST_2</span><br><span class="line">2021-01-15 20:10:15.741  INFO 9984 --- [           main] .d.s.w.r.o.CachingOperationNameGenerator : Generating unique operation named: detailUsingGET_1</span><br><span class="line">2021-01-15 20:10:15.804  INFO 9984 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 9095 (http) with context path &#39;&#39;</span><br><span class="line">2021-01-15 20:10:15.944  INFO 9984 --- [           main] o.dromara.soul.admin.SoulAdminBootstrap  : Started SoulAdminBootstrap in 8.925 seconds (JVM running for 12.176)</span><br><span class="line">2021-01-15 20:10:16.291  INFO 9984 --- [)-192.168.1.107] o.a.c.c.C.[Tomcat].[localhost].[&#x2F;]       : Initializing Spring DispatcherServlet &#39;dispatcherServlet&#39;</span><br><span class="line">2021-01-15 20:10:16.291  INFO 9984 --- [)-192.168.1.107] o.s.web.servlet.DispatcherServlet        : Initializing Servlet &#39;dispatcherServlet&#39;</span><br><span class="line">2021-01-15 20:10:16.306  INFO 9984 --- [)-192.168.1.107] o.s.web.servlet.DispatcherServlet        : Completed initialization in 15 ms</span><br><span class="line">2021-01-15 20:11:58.968  INFO 9984 --- [0.0-9095-exec-1] o.d.s.a.l.websocket.WebsocketCollector   : websocket on open successful....</span><br></pre></td></tr></table></figure>

<p>看到如上日志输出，说明网关和管理端已经正常启动。</p>
<ul>
<li>接下来导入源码中的dubbo例子，soul-examples-apache-dubbo-service，查看dubbo配置，那我们就懂了，用的是zookeeper做为注册中心，并暴露了两个服务类。</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">&quot;http://code.alibabatech.com/schema/dubbo&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://code.alibabatech.com/schema/dubbo</span></span></span><br><span class="line"><span class="tag"><span class="string">       http://code.alibabatech.com/schema/dubbo/dubbo.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">&quot;test-dubbo-service&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">&quot;zookeeper://localhost:2181&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:protocol</span> <span class="attr">name</span>=<span class="string">&quot;dubbo&quot;</span> <span class="attr">port</span>=<span class="string">&quot;20888&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;org.dromara.soul.examples.dubbo.api.service.DubboTestService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dubboTestService&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">timeout</span>=<span class="string">&quot;10000&quot;</span> <span class="attr">interface</span>=<span class="string">&quot;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dubboMultiParamService&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>那么我们就先启动zookeeper</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2021-01-15 20:15:20,391 [myid:] - INFO  [main:ZKDatabase@152] - zookeeper.commitLogCount&#x3D;500</span><br><span class="line">2021-01-15 20:15:20,415 [myid:] - INFO  [main:SnapStream@61] - zookeeper.snapshot.compression.method &#x3D; CHECKED</span><br><span class="line">2021-01-15 20:15:20,447 [myid:] - INFO  [main:FileSnap@85] - Reading snapshot ..\data\version-2\snapshot.7</span><br><span class="line">2021-01-15 20:15:20,466 [myid:] - INFO  [main:DataTree@1730] - The digest in the snapshot has digest version of 2, , with zxid as 0x7, and digest value as 1371985504</span><br><span class="line">2021-01-15 20:15:20,539 [myid:] - INFO  [main:ZKAuditProvider@42] - ZooKeeper audit is disabled.</span><br><span class="line">2021-01-15 20:15:20,544 [myid:] - INFO  [main:FileTxnSnapLog@363] - 74 txns loaded in 25 ms</span><br><span class="line">2021-01-15 20:15:20,545 [myid:] - INFO  [main:ZKDatabase@289] - Snapshot loaded in 153 ms, highest zxid is 0x51, digest is 8209265874</span><br><span class="line">2021-01-15 20:15:20,547 [myid:] - INFO  [main:FileTxnSnapLog@470] - Snapshotting: 0x51 to ..\data\version-2\snapshot.51</span><br><span class="line">2021-01-15 20:15:20,549 [myid:] - INFO  [main:ZooKeeperServer@529] - Snapshot taken in 2 ms</span><br><span class="line">2021-01-15 20:15:20,571 [myid:] - INFO  [ProcessThread(sid:0 cport:2181)::PrepRequestProcessor@136] - PrepRequestProcessor (sid:0) started, reconfigEnabled&#x3D;false</span><br><span class="line">2021-01-15 20:15:20,572 [myid:] - INFO  [main:RequestThrottler@74] - zookeeper.request_throttler.shutdownTimeout &#x3D; 10000</span><br><span class="line">2021-01-15 20:15:20,594 [myid:] - INFO  [main:ContainerManager@83] - Using checkIntervalMs&#x3D;60000 maxPerMinute&#x3D;10000 maxNeverUsedIntervalMs&#x3D;0</span><br></pre></td></tr></table></figure>

<ul>
<li>看到如上日志说明zookeeper已经起来了。接下来就直接运行这个dubbo应用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">2021-01-15 20:25:13.230  INFO 5380 --- [ain-EventThread] o.a.c.f.state.ConnectionStateManager     : State change: CONNECTED</span><br><span class="line">2021-01-15 20:25:13.252  INFO 5380 --- [ain-EventThread] o.a.c.framework.imps.EnsembleTracker     : New config event received: &#123;&#125;</span><br><span class="line">2021-01-15 20:25:13.252  INFO 5380 --- [ain-EventThread] o.a.c.framework.imps.EnsembleTracker     : New config event received: &#123;&#125;</span><br><span class="line">2021-01-15 20:25:14.876  INFO 5380 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8011 (http) with context path &#39;&#39;</span><br><span class="line">2021-01-15 20:25:14.883  INFO 5380 --- [           main] o.d.s.e.a.d.s.TestApacheDubboApplication : Started TestApacheDubboApplication in 6.832 seconds (JVM running for 9.537)</span><br><span class="line">2021-01-15 20:25:15.236  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;findAll&quot;,&quot;pathDesc&quot;:&quot;Get all data&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboTestService&quot;,&quot;methodName&quot;:&quot;findAll&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;findAll&quot;,&quot;parameterTypes&quot;:&quot;&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.257  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;insert&quot;,&quot;pathDesc&quot;:&quot;Insert a row of data&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboTestService&quot;,&quot;methodName&quot;:&quot;insert&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;insert&quot;,&quot;parameterTypes&quot;:&quot;org.dromara.soul.examples.dubbo.api.entity.DubboTest&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.272  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;findById&quot;,&quot;pathDesc&quot;:&quot;Query by Id&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboTestService&quot;,&quot;methodName&quot;:&quot;findById&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;findById&quot;,&quot;parameterTypes&quot;:&quot;java.lang.String&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.286  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;findByIdsAndName&quot;,&quot;pathDesc&quot;:&quot;&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService&quot;,&quot;methodName&quot;:&quot;findByIdsAndName&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;findByIdsAndName&quot;,&quot;parameterTypes&quot;:&quot;java.util.List,java.lang.String&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.299  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;findByListId&quot;,&quot;pathDesc&quot;:&quot;&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService&quot;,&quot;methodName&quot;:&quot;findByListId&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;findByListId&quot;,&quot;parameterTypes&quot;:&quot;java.util.List&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.317  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;batchSave&quot;,&quot;pathDesc&quot;:&quot;&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService&quot;,&quot;methodName&quot;:&quot;batchSave&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;batchSave&quot;,&quot;parameterTypes&quot;:&quot;java.util.List&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.332  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;findByStringArray&quot;,&quot;pathDesc&quot;:&quot;&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService&quot;,&quot;methodName&quot;:&quot;findByStringArray&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;findByStringArray&quot;,&quot;parameterTypes&quot;:&quot;[Ljava.lang.String;&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.347  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;findByArrayIdsAndName&quot;,&quot;pathDesc&quot;:&quot;&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService&quot;,&quot;methodName&quot;:&quot;findByArrayIdsAndName&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;findByArrayIdsAndName&quot;,&quot;parameterTypes&quot;:&quot;[Ljava.lang.Integer;,java.lang.String&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.361  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;saveComplexBeanTest&quot;,&quot;pathDesc&quot;:&quot;&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService&quot;,&quot;methodName&quot;:&quot;saveComplexBeanTest&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;saveComplexBeanTest&quot;,&quot;parameterTypes&quot;:&quot;org.dromara.soul.examples.dubbo.api.entity.ComplexBeanTest&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.375  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;saveComplexBeanTestAndName&quot;,&quot;pathDesc&quot;:&quot;&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService&quot;,&quot;methodName&quot;:&quot;saveComplexBeanTestAndName&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;saveComplexBeanTestAndName&quot;,&quot;parameterTypes&quot;:&quot;org.dromara.soul.examples.dubbo.api.entity.ComplexBeanTest,java.lang.String&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line">2021-01-15 20:25:15.390  INFO 5380 --- [pool-2-thread-1] o.d.s.client.common.utils.RegisterUtils  : dubbo client register success: &#123;&quot;appName&quot;:&quot;dubbo&quot;,&quot;contextPath&quot;:&quot;&#x2F;dubbo&quot;,&quot;path&quot;:&quot;&#x2F;dubbo&#x2F;batchSaveAndNameAndId&quot;,&quot;pathDesc&quot;:&quot;&quot;,&quot;rpcType&quot;:&quot;dubbo&quot;,&quot;serviceName&quot;:&quot;org.dromara.soul.examples.dubbo.api.service.DubboMultiParamService&quot;,&quot;methodName&quot;:&quot;batchSaveAndNameAndId&quot;,&quot;ruleName&quot;:&quot;&#x2F;dubbo&#x2F;batchSaveAndNameAndId&quot;,&quot;parameterTypes&quot;:&quot;java.util.List,java.lang.String,java.lang.String&quot;,&quot;rpcExt&quot;:&quot;&#123;\&quot;group\&quot;:\&quot;\&quot;,\&quot;version\&quot;:\&quot;\&quot;,\&quot;loadbalance\&quot;:\&quot;random\&quot;,\&quot;retries\&quot;:2,\&quot;timeout\&quot;:10000,\&quot;url\&quot;:\&quot;\&quot;&#125;&quot;,&quot;enabled&quot;:true&#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>看到如上日志，dubbo就成功发布到了网关中。好，那么我们就来试试效果如何。</p>
<ul>
<li>小试牛刀</li>
</ul>
<p>无参接口调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SoulDubboClient(path = &quot;/findById&quot;, desc = &quot;Query by Id&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DubboTest <span class="title">findById</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</span><br><span class="line">    DubboTest dubboTest = <span class="keyword">new</span> DubboTest();</span><br><span class="line">    dubboTest.setId(id);</span><br><span class="line">    dubboTest.setName(<span class="string">&quot;hello world Soul Apache, findById&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> dubboTest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="assets/20210115204523-5cwfuvz-success1.png" alt="success1.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@SoulDubboClient(path = &quot;/findAll&quot;, desc = &quot;Get all data&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DubboTest <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DubboTest dubboTest = <span class="keyword">new</span> DubboTest();</span><br><span class="line">        dubboTest.setName(<span class="string">&quot;hello world Soul Apache, findAll&quot;</span>);</span><br><span class="line">        dubboTest.setId(String.valueOf(<span class="keyword">new</span> Random().nextInt()));</span><br><span class="line">        <span class="keyword">return</span> dubboTest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="assets/20210115205750-wteoiof-2.png" alt="2.png"></p>
<p>有参接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SoulDubboClient(path = &quot;/insert&quot;, desc = &quot;Insert a row of data&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DubboTest <span class="title">insert</span><span class="params">(<span class="keyword">final</span> DubboTest dubboTest)</span> </span>&#123;</span><br><span class="line">    dubboTest.setName(<span class="string">&quot;hello world Soul Apache Dubbo: &quot;</span> + dubboTest.getName());</span><br><span class="line">    <span class="keyword">return</span> dubboTest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;ids&quot;</span>:[<span class="number">1</span>,<span class="number">2</span>],<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;cuicui&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src="assets/20210115210902-v92ad0f-4.png" alt="4.png"></p>
<p>多参接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SoulDubboClient(path = &quot;/findByIdsAndName&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DubboTest <span class="title">findByIdsAndName</span><span class="params">(List&lt;Integer&gt; ids, String name)</span> </span>&#123;</span><br><span class="line">    DubboTest test = <span class="keyword">new</span> DubboTest();</span><br><span class="line">    test.setId(ids.toString());</span><br><span class="line">    test.setName(<span class="string">&quot;hello world soul apache dubbo param findByIdsAndName ：&quot;</span> + name);</span><br><span class="line">    <span class="keyword">return</span> test;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="assets/20210115211402-b2u0bfp-5.png" alt="5.png"></p>
<p><img src="assets/20210115211439-u8m9oao-6.png" alt="6.png"></p>
<p>多参接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SoulDubboClient(path = &quot;/findByArrayIdsAndName&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DubboTest <span class="title">findByArrayIdsAndName</span><span class="params">(Integer[] ids, String name)</span> </span>&#123;</span><br><span class="line">    DubboTest test = <span class="keyword">new</span> DubboTest();</span><br><span class="line">    test.setId(Arrays.toString(ids));</span><br><span class="line">    test.setName(<span class="string">&quot;hello world soul apache dubbo param findByArrayIdsAndName ：&quot;</span> + name);</span><br><span class="line">    <span class="keyword">return</span> test;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>参数：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;ids&quot;</span>:[<span class="number">1</span>,<span class="number">2</span>],<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;cuicui&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<p><img src="assets/20210115211654-0n85k5a-9.png" alt="9.png"></p>
<p>集合对象参数接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SoulDubboClient(path = &quot;/batchSave&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DubboTest <span class="title">batchSave</span><span class="params">(List&lt;DubboTest&gt; dubboTestList)</span> </span>&#123;</span><br><span class="line">    DubboTest test = <span class="keyword">new</span> DubboTest();</span><br><span class="line">    test.setId(dubboTestList.stream().map(DubboTest::getId).collect(Collectors.joining(<span class="string">&quot;-&quot;</span>)));</span><br><span class="line">    test.setName(<span class="string">&quot;hello world soul apache dubbo param batchSave :&quot;</span> + dubboTestList.stream().map(DubboTest::getName).collect(Collectors.joining(<span class="string">&quot;-&quot;</span>)));</span><br><span class="line">    <span class="keyword">return</span> test;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;dubboTestList&quot;</span>:[&#123;<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;cuicui&quot;</span>&#125;,&#123;<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;cuicui&quot;</span>&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>响应：</p>
<p><img src="assets/20210115212458-4kutp24-10.png" alt="10.png"></p>
<p>复杂对象参数接口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">@SoulDubboClient(path &#x3D; &quot;&#x2F;saveComplexBeanTest&quot;)</span><br><span class="line">public DubboTest saveComplexBeanTest(ComplexBeanTest complexBeanTest) &#123;</span><br><span class="line">    DubboTest test &#x3D; new DubboTest();</span><br><span class="line">    test.setId(complexBeanTest.getIdLists().toString());</span><br><span class="line">    test.setName(&quot;hello world soul apache dubbo param saveComplexBeanTest :&quot; + complexBeanTest.getDubboTest().getName());</span><br><span class="line">    return test;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;dubboTest&quot;</span>:&#123;<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;cuicui&quot;</span>&#125;,<span class="attr">&quot;idLists&quot;</span>:[<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>],<span class="attr">&quot;idMaps&quot;</span>:&#123;<span class="attr">&quot;id&quot;</span>:<span class="number">1</span>,<span class="attr">&quot;name&quot;</span>:<span class="string">&quot;cuicui&quot;</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>响应：</p>
<p><img src="assets/20210115213646-id6y2s6-13.png" alt="13.png"></p>
<p>常用的传参方式都用了一遍，轻松无压力。只需使用http post方式，把json参数通过body传输，通过网关即可轻松访问dubbo服务。</p>
<p><strong>好了，总结一下：</strong></p>
<ol>
<li><strong>dubbo应用如何使用soul网关</strong></li>
</ol>
<ul>
<li>引入soul依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soul-spring-boot-starter-client-apache-dubbo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;soul.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置soul-admin地址、contextPath、应用名称</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">soul:</span></span><br><span class="line">  <span class="attr">dubbo:</span></span><br><span class="line">    <span class="attr">adminUrl:</span> <span class="string">http://localhost:9095</span></span><br><span class="line">    <span class="attr">contextPath:</span> <span class="string">/dubbo</span></span><br><span class="line">    <span class="attr">appName:</span> <span class="string">dubbo</span></span><br></pre></td></tr></table></figure>

<ul>
<li>需要发布到soul的接口上增加注解@SoulDubboClient并配置映射路径</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@SoulDubboClient(path &#x3D; &quot;&#x2F;findById&quot;, desc &#x3D; &quot;Query by Id&quot;)</span><br></pre></td></tr></table></figure>

<p><strong>2.dubbo服务通过soul网关进行调用</strong></p>
<p>发送http post请求，body传输json参数</p>
<p><strong>遇到的问题：</strong></p>
<p>调用有参接口而未传入参数响应错误信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;code&quot;:431,&quot;message&quot;:&quot;Dubbo must have body param, please enter the JSON format in the body!&quot;,&quot;data&quot;:null&#125;</span><br></pre></td></tr></table></figure>

<p>未开启dubbo插件调用接口响应错误信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;code&quot;:-103,&quot;message&quot;:&quot;Service invocation exception, or no result is returned!&quot;,&quot;data&quot;:null&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-dubbo-run/" data-id="ckn5dfeoe000iqkvnej0u7bgd" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-dubbo-plugin" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-dubbo-plugin/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.733Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="dubbo插件的作用是什么？"><a href="#dubbo插件的作用是什么？" class="headerlink" title="dubbo插件的作用是什么？"></a>dubbo插件的作用是什么？</h4><p>dubbo插件是将<code>http协议</code> 转换成<code>dubbo协议</code> 的插件,也是网关实现dubbo泛化调用的关键。</p>
<h4 id="什么是泛化调用？"><a href="#什么是泛化调用？" class="headerlink" title="什么是泛化调用？"></a>什么是泛化调用？</h4><p>泛化接口调用方式主要用于客户端没有 API 接口及模型类元的情况，参数及返回值中的所有 POJO 均用 Map 表示，通常用于框架集成，比如：实现一个通用的服务测试框架，可通过 GenericService 调用所有服务实现。</p>
<h4 id="为什么使用泛化调用？"><a href="#为什么使用泛化调用？" class="headerlink" title="为什么使用泛化调用？"></a>为什么使用泛化调用？</h4><p>一般使用dubbo，provider端需要暴露出接口和方法，consumer端要十分明确服务使用的接口定义和方法定义（还有入参返参类型等等信息，常常还需要基于provider端提供的API），两端才能正常通信调用。然而存在一种使用场景，调用方并不关心要调用的接口的详细定义，它只关注我要调用哪个方法，需要传什么参数，我能接收到什么返回结果即可，这样可以大大降低consumer端和provider端的耦合性。所以为了应对以上的需求，dubbo提供了泛化调用，也就是在consumer只知道一个接口全限定名以及入参和返参的情况下，就可以调用provider端的调用，而不需要传统的接口定义这些繁杂的结构。</p>
<h4 id="dubbo插件如何工作？"><a href="#dubbo插件如何工作？" class="headerlink" title="dubbo插件如何工作？"></a>dubbo插件如何工作？</h4><p>soul网关把http请求参数转换为泛化参数后根据元数据进行dubbo泛化调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">    protected Mono&lt;Void&gt; doExecute(final ServerWebExchange exchange, final SoulPluginChain chain, final SelectorData selector, final RuleData rule) &#123;</span><br><span class="line">        &#x2F;&#x2F; 获取请求体数据</span><br><span class="line">        String body &#x3D; exchange.getAttribute(Constants.DUBBO_PARAMS);</span><br><span class="line">        SoulContext soulContext &#x3D; exchange.getAttribute(Constants.CONTEXT);</span><br><span class="line">        assert soulContext !&#x3D; null;</span><br><span class="line">        &#x2F;&#x2F; 获取dubbo元数据</span><br><span class="line">        MetaData metaData &#x3D; exchange.getAttribute(Constants.META_DATA);</span><br><span class="line">        if (!checkMetaData(metaData)) &#123;</span><br><span class="line">            assert metaData !&#x3D; null;</span><br><span class="line">            log.error(&quot; path is :&#123;&#125;, meta data have error.... &#123;&#125;&quot;, soulContext.getPath(), metaData.toString());</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">            Object error &#x3D; SoulResultWrap.error(SoulResultEnum.META_DATA_ERROR.getCode(), SoulResultEnum.META_DATA_ERROR.getMsg(), null);</span><br><span class="line">            return WebFluxResultUtils.result(exchange, error);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 如果又参数类型而无请求体参数则报错</span><br><span class="line">        if (StringUtils.isNoneBlank(metaData.getParameterTypes()) &amp;&amp; StringUtils.isBlank(body)) &#123;</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.INTERNAL_SERVER_ERROR);</span><br><span class="line">            Object error &#x3D; SoulResultWrap.error(SoulResultEnum.DUBBO_HAVE_BODY_PARAM.getCode(), SoulResultEnum.DUBBO_HAVE_BODY_PARAM.getMsg(), null);</span><br><span class="line">            return WebFluxResultUtils.result(exchange, error);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; dubbo泛化调用</span><br><span class="line">        final Mono&lt;Object&gt; result &#x3D; dubboProxyService.genericInvoker(body, metaData, exchange);</span><br><span class="line">        return result.then(chain.execute(exchange));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public Mono&lt;Object&gt; genericInvoker(final String body, final MetaData metaData, final ServerWebExchange exchange) throws SoulException &#123;</span><br><span class="line">        &#x2F;&#x2F; issue(https:&#x2F;&#x2F;github.com&#x2F;dromara&#x2F;soul&#x2F;issues&#x2F;471), add dubbo tag route</span><br><span class="line">        &#x2F;&#x2F; 如果存在tag标签则放入</span><br><span class="line">        String dubboTagRouteFromHttpHeaders &#x3D; exchange.getRequest().getHeaders().getFirst(Constants.DUBBO_TAG_ROUTE);</span><br><span class="line">        if (StringUtils.isNotBlank(dubboTagRouteFromHttpHeaders)) &#123;</span><br><span class="line">            RpcContext.getContext().setAttachment(CommonConstants.TAG_KEY, dubboTagRouteFromHttpHeaders);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 缓存中获取服务引用</span><br><span class="line">        ReferenceConfig&lt;GenericService&gt; reference &#x3D; ApplicationConfigCache.getInstance().get(metaData.getPath());</span><br><span class="line">        if (Objects.isNull(reference) || StringUtils.isEmpty(reference.getInterface())) &#123;</span><br><span class="line">            ApplicationConfigCache.getInstance().invalidate(metaData.getPath());</span><br><span class="line">            reference &#x3D; ApplicationConfigCache.getInstance().initRef(metaData);</span><br><span class="line">        &#125;</span><br><span class="line">        GenericService genericService &#x3D; reference.get();</span><br><span class="line">        &#x2F;&#x2F; json参数转化为dubbo泛化参数</span><br><span class="line">        Pair&lt;String[], Object[]&gt; pair;</span><br><span class="line">        if (ParamCheckUtils.dubboBodyIsEmpty(body)) &#123;</span><br><span class="line">            pair &#x3D; new ImmutablePair&lt;&gt;(new String[]&#123;&#125;, new Object[]&#123;&#125;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            pair &#x3D; dubboParamResolveService.buildParameter(body, metaData.getParameterTypes());</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 真正调用dubbo服务</span><br><span class="line">        CompletableFuture&lt;Object&gt; future &#x3D; genericService.$invokeAsync(metaData.getMethodName(), pair.getLeft(), pair.getRight());</span><br><span class="line">        return Mono.fromFuture(future.thenApply(ret -&gt; &#123;</span><br><span class="line">            if (Objects.isNull(ret)) &#123;</span><br><span class="line">                ret &#x3D; Constants.DUBBO_RPC_RESULT_EMPTY;</span><br><span class="line">            &#125;</span><br><span class="line">            exchange.getAttributes().put(Constants.DUBBO_RPC_RESULT, ret);</span><br><span class="line">            exchange.getAttributes().put(Constants.CLIENT_RESPONSE_RESULT_TYPE, ResultEnum.SUCCESS.getName());</span><br><span class="line">            return ret;</span><br><span class="line">        &#125;)).onErrorMap(exception -&gt; exception instanceof GenericException ? new SoulException(((GenericException) exception).getExceptionMessage()) : new SoulException(exception));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-dubbo-plugin/" data-id="ckn5dfeo00002qkvn5cmb4an2" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-divide-plugin" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-divide-plugin/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.723Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="divide-plugin是什么？"><a href="#divide-plugin是什么？" class="headerlink" title="divide plugin是什么？"></a>divide plugin是什么？</h4><ol>
<li>divide插件是网关处理 <code>http协议</code>请求的核心处理插件。</li>
<li>divide插件是进行http正向代理的插件，所有http类型的请求，都是由该插件进行负载均衡的调用。</li>
</ol>
<h4 id="divide-plugin如何工作？"><a href="#divide-plugin如何工作？" class="headerlink" title="divide plugin如何工作？"></a>divide plugin如何工作？</h4><p>soul plugin 通过职责链模式串联。初始化网关的web服务SoulWebHandler时候加载了所有配置的插件保存在<br>DefaultSoulPluginChain职责链对象中。当请求来了之后，按照插件顺序依次执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Init SoulWebHandler.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> plugins this plugins is All impl SoulPlugin.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> &#123;<span class="doctag">@linkplain</span> SoulWebHandler&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean(&quot;webHandler&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> SoulWebHandler <span class="title">soulWebHandler</span><span class="params">(<span class="keyword">final</span> ObjectProvider&lt;List&lt;SoulPlugin&gt;&gt; plugins)</span> </span>&#123;</span><br><span class="line">    List&lt;SoulPlugin&gt; pluginList = plugins.getIfAvailable(Collections::emptyList);</span><br><span class="line">    <span class="keyword">final</span> List&lt;SoulPlugin&gt; soulPlugins = pluginList.stream()</span><br><span class="line">            .sorted(Comparator.comparingInt(SoulPlugin::getOrder)).collect(Collectors.toList());</span><br><span class="line">    soulPlugins.forEach(soulPlugin -&gt; log.info(<span class="string">&quot;load plugin:[&#123;&#125;] [&#123;&#125;]&quot;</span>, soulPlugin.named(), soulPlugin.getClass().getName()));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SoulWebHandler(soulPlugins);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public Mono&lt;Void&gt; handle(@NonNull final ServerWebExchange exchange) &#123;</span><br><span class="line">    MetricsTrackerFacade.getInstance().counterInc(MetricsLabelEnum.REQUEST_TOTAL.getName());</span><br><span class="line">    Optional&lt;HistogramMetricsTrackerDelegate&gt; startTimer &#x3D; MetricsTrackerFacade.getInstance().histogramStartTimer(MetricsLabelEnum.REQUEST_LATENCY.getName());</span><br><span class="line">    &#x2F;&#x2F; 依次执行插件处理</span><br><span class="line">    return new DefaultSoulPluginChain(plugins).execute(exchange).subscribeOn(scheduler)</span><br><span class="line">            .doOnSuccess(t -&gt; startTimer.ifPresent(time -&gt; MetricsTrackerFacade.getInstance().histogramObserveDuration(time)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DividePlugin</span> <span class="keyword">extends</span> <span class="title">AbstractSoulPlugin</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Mono&lt;Void&gt; <span class="title">doExecute</span><span class="params">(<span class="keyword">final</span> ServerWebExchange exchange, <span class="keyword">final</span> SoulPluginChain chain, <span class="keyword">final</span> SelectorData selector, <span class="keyword">final</span> RuleData rule)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 获取上下文信息（参数透传的一种方式）</span></span><br><span class="line">        <span class="keyword">final</span> SoulContext soulContext = exchange.getAttribute(Constants.CONTEXT);</span><br><span class="line">        <span class="keyword">assert</span> soulContext != <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 规则处理反序列化</span></span><br><span class="line">        <span class="keyword">final</span> DivideRuleHandle ruleHandle = GsonUtils.getInstance().fromJson(rule.getHandle(), DivideRuleHandle.class);</span><br><span class="line">        <span class="comment">// 根据selector id从本地缓存中获取被代理的服务</span></span><br><span class="line">        <span class="keyword">final</span> List&lt;DivideUpstream&gt; upstreamList = UpstreamCacheManager.getInstance().findUpstreamListBySelectorId(selector.getId());</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(upstreamList)) &#123;</span><br><span class="line">            <span class="comment">// 如果没有一个被代理的服务就返回错误</span></span><br><span class="line">            log.error(<span class="string">&quot;divide upstream configuration error： &#123;&#125;&quot;</span>, rule.toString());</span><br><span class="line">            Object error = SoulResultWrap.error(SoulResultEnum.CANNOT_FIND_URL.getCode(), SoulResultEnum.CANNOT_FIND_URL.getMsg(), <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> WebFluxResultUtils.result(exchange, error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取请求目标ip地址</span></span><br><span class="line">        <span class="keyword">final</span> String ip = Objects.requireNonNull(exchange.getRequest().getRemoteAddress()).getAddress().getHostAddress();</span><br><span class="line">        <span class="comment">// 使用选择器做第一次流量的筛选（这里通过spi加载扩展的负载均衡算法进行处理）</span></span><br><span class="line">        DivideUpstream divideUpstream = LoadBalanceUtils.selector(upstreamList, ruleHandle.getLoadBalance(), ip);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(divideUpstream)) &#123;</span><br><span class="line">            <span class="comment">// 筛选后找不到一个被代理的服务就返回错误</span></span><br><span class="line">            log.error(<span class="string">&quot;divide has no upstream&quot;</span>);</span><br><span class="line">            Object error = SoulResultWrap.error(SoulResultEnum.CANNOT_FIND_URL.getCode(), SoulResultEnum.CANNOT_FIND_URL.getMsg(), <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> WebFluxResultUtils.result(exchange, error);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// set the http url</span></span><br><span class="line">        <span class="comment">// 拼接出最终目标url</span></span><br><span class="line">        String domain = buildDomain(divideUpstream);</span><br><span class="line">        String realURL = buildRealURL(domain, soulContext, exchange);</span><br><span class="line">        <span class="comment">// 把加工的信息写入请求ServerWebExchange中</span></span><br><span class="line">        exchange.getAttributes().put(Constants.HTTP_URL, realURL);</span><br><span class="line">        <span class="comment">// set the http timeout</span></span><br><span class="line">        exchange.getAttributes().put(Constants.HTTP_TIME_OUT, ruleHandle.getTimeout());</span><br><span class="line">        exchange.getAttributes().put(Constants.HTTP_RETRY, ruleHandle.getRetry());</span><br><span class="line">        <span class="comment">// 调用下一个插件处理</span></span><br><span class="line">        <span class="keyword">return</span> chain.execute(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-divide-plugin/" data-id="ckn5dfenz0001qkvn3wda28bu" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-context-path-plugin" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-context-path-plugin/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.710Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>网关context_path插件，根据文档说法，是用来对目标服务调用的时候，重写请求路径的contextPath。</p>
<p>我们就来试试吧。</p>
<h2 id="context-path插件设置"><a href="#context-path插件设置" class="headerlink" title="context_path插件设置"></a>context_path插件设置</h2><ol>
<li>网关引入context_path插件</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soul-spring-boot-starter-plugin-context-path<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>2.启动网关后在admin中开启context_path插件</p>
<p><img src="assets/20210128004213-o7s9vqe-%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210128004129.png" alt="微信截图20210128004129.png"></p>
<p>3.配置插件选择器和规则</p>
<p><img src="assets/20210128004721-o38rcag-%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210128004646.png" alt="微信截图20210128004646.png"><img src="assets/20210128004721-kt8iuf9-%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210128004656.png" alt="微信截图20210128004656.png"></p>
<p>4.尝试请求订单接口</p>
<p><img src="assets/20210128004815-oypa6xh-%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210128004754.png" alt="微信截图20210128004754.png"></p>
<p>从图中可看到，已经请求成功，插件生效了。</p>
<h2 id="context-path插件使用场景"><a href="#context-path插件使用场景" class="headerlink" title="context_path插件使用场景"></a>context_path插件使用场景</h2><p>当匹配到请求后，设置自定义的contextPath，那么就会根据请求的Url截取自定义的contextPath获取真正的Url。大白话就是真实请求的路径=请求路径删除前缀contextPath。例如请求路径为/soul/http/order， 配置的contextPath为/soul/http，那么真正请求的url为/order。可以对真实服务做一个隐藏、也可以用来替换老接口。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-context-path-plugin/" data-id="ckn5dfent0000qkvn9pey58dx" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-zookeeper-sync-data" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-zookeeper-sync-data/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.581Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="soul网关采用zookeeper方式同步数据，对比http长轮询方式有何优势？"><a href="#soul网关采用zookeeper方式同步数据，对比http长轮询方式有何优势？" class="headerlink" title="soul网关采用zookeeper方式同步数据，对比http长轮询方式有何优势？"></a>soul网关采用zookeeper方式同步数据，对比http长轮询方式有何优势？</h2><ol>
<li>websocket方式能实时通知，而http长轮询方式只能做到准实时。</li>
<li>websocket同步采用增量处理，而http长轮询方式是全量数据，当数据量大的时候http长轮询方式就会有性能问题。</li>
</ol>
<h2 id="zookeeper方式同步数据原理"><a href="#zookeeper方式同步数据原理" class="headerlink" title="zookeeper方式同步数据原理"></a>zookeeper方式同步数据原理</h2><p>基于 zookeeper 的同步原理很简单，主要是依赖 <code>zookeeper</code> 的 watch 机制，<code>soul-web</code> 会监听配置的节点，<code>soul-admin</code> 在启动的时候，会将数据全量写入 <code>zookeeper</code>，后续数据发生变更时，会增量更新 <code>zookeeper</code> 的节点，与此同时，<code>soul-web</code> 会监听配置信息的节点，一旦有信息变更时，会更新本地缓存。</p>
<p>![soulzookeeper1.png](assets/20210121150905-ac20c6j-soul-zookeeper (1).png)<br>![soulzookeeper2.png](assets/20210121150905-snaq3b4-soul-zookeeper (2).png)<br><img src="assets/20210121150905-ehkvt21-soul-zookeeper.png" alt="soulzookeeper.png"></p>
<h2 id="zookeeper同步方式详解"><a href="#zookeeper同步方式详解" class="headerlink" title="zookeeper同步方式详解"></a>zookeeper同步方式详解</h2><p>网关中负责同步的类是ZookeeperSyncDataService。其作用就是网关启动的时候读取admin写入zookeeper中的节点数据，并进行监听。非常之简单易懂。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperSyncDataService</span> <span class="keyword">implements</span> <span class="title">SyncDataService</span>, <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ZkClient zkClient;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MetaDataSubscriber&gt; metaDataSubscribers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AuthDataSubscriber&gt; authDataSubscribers;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 启动则读取全量数据并进行监听</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiates a new Zookeeper cache manager.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> zkClient             the zk client</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pluginDataSubscriber the plugin data subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metaDataSubscribers  the meta data subscribers</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authDataSubscribers  the auth data subscribers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ZookeeperSyncDataService</span><span class="params">(<span class="keyword">final</span> ZkClient zkClient, <span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">final</span> List&lt;MetaDataSubscriber&gt; metaDataSubscribers, <span class="keyword">final</span> List&lt;AuthDataSubscriber&gt; authDataSubscribers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.zkClient = zkClient;</span><br><span class="line">        <span class="keyword">this</span>.pluginDataSubscriber = pluginDataSubscriber;</span><br><span class="line">        <span class="keyword">this</span>.metaDataSubscribers = metaDataSubscribers;</span><br><span class="line">        <span class="keyword">this</span>.authDataSubscribers = authDataSubscribers;</span><br><span class="line">        watcherData();</span><br><span class="line">        watchAppAuth();</span><br><span class="line">        watchMetaData();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">watcherData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String pluginParent = ZkPathConstants.PLUGIN_PARENT;</span><br><span class="line">        List&lt;String&gt; pluginZKs = zkClientGetChildren(pluginParent);</span><br><span class="line">        <span class="keyword">for</span> (String pluginName : pluginZKs) &#123;</span><br><span class="line">            watcherAll(pluginName);</span><br><span class="line">        &#125;</span><br><span class="line">        zkClient.subscribeChildChanges(pluginParent, (parentPath, currentChildren) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isNotEmpty(currentChildren)) &#123;</span><br><span class="line">                <span class="keyword">for</span> (String pluginName : currentChildren) &#123;</span><br><span class="line">                    watcherAll(pluginName);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">watcherAll</span><span class="params">(<span class="keyword">final</span> String pluginName)</span> </span>&#123;</span><br><span class="line">        watcherPlugin(pluginName);</span><br><span class="line">        watcherSelector(pluginName);</span><br><span class="line">        watcherRule(pluginName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">watcherPlugin</span><span class="params">(<span class="keyword">final</span> String pluginName)</span> </span>&#123;</span><br><span class="line">        String pluginPath = ZkPathConstants.buildPluginPath(pluginName);</span><br><span class="line">        <span class="keyword">if</span> (!zkClient.exists(pluginPath)) &#123;</span><br><span class="line">            zkClient.createPersistent(pluginPath, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        cachePluginData(zkClient.readData(pluginPath));</span><br><span class="line">        subscribePluginDataChanges(pluginPath, pluginName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">watcherSelector</span><span class="params">(<span class="keyword">final</span> String pluginName)</span> </span>&#123;</span><br><span class="line">        String selectorParentPath = ZkPathConstants.buildSelectorParentPath(pluginName);</span><br><span class="line">        List&lt;String&gt; childrenList = zkClientGetChildren(selectorParentPath);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(childrenList)) &#123;</span><br><span class="line">            childrenList.forEach(children -&gt; &#123;</span><br><span class="line">                String realPath = buildRealPath(selectorParentPath, children);</span><br><span class="line">                cacheSelectorData(zkClient.readData(realPath));</span><br><span class="line">                subscribeSelectorDataChanges(realPath);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        subscribeChildChanges(ConfigGroupEnum.SELECTOR, selectorParentPath, childrenList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">watcherRule</span><span class="params">(<span class="keyword">final</span> String pluginName)</span> </span>&#123;</span><br><span class="line">        String ruleParent = ZkPathConstants.buildRuleParentPath(pluginName);</span><br><span class="line">        List&lt;String&gt; childrenList = zkClientGetChildren(ruleParent);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(childrenList)) &#123;</span><br><span class="line">            childrenList.forEach(children -&gt; &#123;</span><br><span class="line">                String realPath = buildRealPath(ruleParent, children);</span><br><span class="line">                cacheRuleData(zkClient.readData(realPath));</span><br><span class="line">                subscribeRuleDataChanges(realPath);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        subscribeChildChanges(ConfigGroupEnum.RULE, ruleParent, childrenList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">watchAppAuth</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String appAuthParent = ZkPathConstants.APP_AUTH_PARENT;</span><br><span class="line">        List&lt;String&gt; childrenList = zkClientGetChildren(appAuthParent);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(childrenList)) &#123;</span><br><span class="line">            childrenList.forEach(children -&gt; &#123;</span><br><span class="line">                String realPath = buildRealPath(appAuthParent, children);</span><br><span class="line">                cacheAuthData(zkClient.readData(realPath));</span><br><span class="line">                subscribeAppAuthDataChanges(realPath);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        subscribeChildChanges(ConfigGroupEnum.APP_AUTH, appAuthParent, childrenList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">watchMetaData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String metaDataPath = ZkPathConstants.META_DATA;</span><br><span class="line">        List&lt;String&gt; childrenList = zkClientGetChildren(metaDataPath);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(childrenList)) &#123;</span><br><span class="line">            childrenList.forEach(children -&gt; &#123;</span><br><span class="line">                String realPath = buildRealPath(metaDataPath, children);</span><br><span class="line">                cacheMetaData(zkClient.readData(realPath));</span><br><span class="line">                subscribeMetaDataChanges(realPath);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        subscribeChildChanges(ConfigGroupEnum.APP_AUTH, metaDataPath, childrenList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribeChildChanges</span><span class="params">(<span class="keyword">final</span> ConfigGroupEnum groupKey, <span class="keyword">final</span> String groupParentPath, <span class="keyword">final</span> List&lt;String&gt; childrenList)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (groupKey) &#123;</span><br><span class="line">            <span class="keyword">case</span> SELECTOR:</span><br><span class="line">                zkClient.subscribeChildChanges(groupParentPath, (parentPath, currentChildren) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(currentChildren)) &#123;</span><br><span class="line">                        List&lt;String&gt; addSubscribePath = addSubscribePath(childrenList, currentChildren);</span><br><span class="line">                        addSubscribePath.stream().map(addPath -&gt; &#123;</span><br><span class="line">                            String realPath = buildRealPath(parentPath, addPath);</span><br><span class="line">                            cacheSelectorData(zkClient.readData(realPath));</span><br><span class="line">                            <span class="keyword">return</span> realPath;</span><br><span class="line">                        &#125;).forEach(<span class="keyword">this</span>::subscribeSelectorDataChanges);</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RULE:</span><br><span class="line">                zkClient.subscribeChildChanges(groupParentPath, (parentPath, currentChildren) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(currentChildren)) &#123;</span><br><span class="line">                        List&lt;String&gt; addSubscribePath = addSubscribePath(childrenList, currentChildren);</span><br><span class="line">                        <span class="comment">// Get the newly added node data and subscribe to that node</span></span><br><span class="line">                        addSubscribePath.stream().map(addPath -&gt; &#123;</span><br><span class="line">                            String realPath = buildRealPath(parentPath, addPath);</span><br><span class="line">                            cacheRuleData(zkClient.readData(realPath));</span><br><span class="line">                            <span class="keyword">return</span> realPath;</span><br><span class="line">                        &#125;).forEach(<span class="keyword">this</span>::subscribeRuleDataChanges);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> APP_AUTH:</span><br><span class="line">                zkClient.subscribeChildChanges(groupParentPath, (parentPath, currentChildren) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(currentChildren)) &#123;</span><br><span class="line">                        <span class="keyword">final</span> List&lt;String&gt; addSubscribePath = addSubscribePath(childrenList, currentChildren);</span><br><span class="line">                        addSubscribePath.stream().map(children -&gt; &#123;</span><br><span class="line">                            <span class="keyword">final</span> String realPath = buildRealPath(parentPath, children);</span><br><span class="line">                            cacheAuthData(zkClient.readData(realPath));</span><br><span class="line">                            <span class="keyword">return</span> realPath;</span><br><span class="line">                        &#125;).forEach(<span class="keyword">this</span>::subscribeAppAuthDataChanges);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> META_DATA:</span><br><span class="line">                zkClient.subscribeChildChanges(groupParentPath, (parentPath, currentChildren) -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (CollectionUtils.isNotEmpty(currentChildren)) &#123;</span><br><span class="line">                        <span class="keyword">final</span> List&lt;String&gt; addSubscribePath = addSubscribePath(childrenList, currentChildren);</span><br><span class="line">                        addSubscribePath.stream().map(children -&gt; &#123;</span><br><span class="line">                            <span class="keyword">final</span> String realPath = buildRealPath(parentPath, children);</span><br><span class="line">                            cacheMetaData(zkClient.readData(realPath));</span><br><span class="line">                            <span class="keyword">return</span> realPath;</span><br><span class="line">                        &#125;).forEach(<span class="keyword">this</span>::subscribeMetaDataChanges);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unexpected groupKey: &quot;</span> + groupKey);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribePluginDataChanges</span><span class="params">(<span class="keyword">final</span> String pluginPath, <span class="keyword">final</span> String pluginName)</span> </span>&#123;</span><br><span class="line">        zkClient.subscribeDataChanges(pluginPath, <span class="keyword">new</span> IZkDataListener() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataChange</span><span class="params">(<span class="keyword">final</span> String dataPath, <span class="keyword">final</span> Object data)</span> </span>&#123;</span><br><span class="line">                Optional.ofNullable(data)</span><br><span class="line">                        .ifPresent(d -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSubscribe((PluginData) d)));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataDeleted</span><span class="params">(<span class="keyword">final</span> String dataPath)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> PluginData data = <span class="keyword">new</span> PluginData();</span><br><span class="line">                data.setName(pluginName);</span><br><span class="line">                Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.unSubscribe(data));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribeSelectorDataChanges</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">        zkClient.subscribeDataChanges(path, <span class="keyword">new</span> IZkDataListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataChange</span><span class="params">(<span class="keyword">final</span> String dataPath, <span class="keyword">final</span> Object data)</span> </span>&#123;</span><br><span class="line">                cacheSelectorData((SelectorData) data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataDeleted</span><span class="params">(<span class="keyword">final</span> String dataPath)</span> </span>&#123;</span><br><span class="line">                unCacheSelectorData(dataPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribeRuleDataChanges</span><span class="params">(<span class="keyword">final</span> String path)</span> </span>&#123;</span><br><span class="line">        zkClient.subscribeDataChanges(path, <span class="keyword">new</span> IZkDataListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataChange</span><span class="params">(<span class="keyword">final</span> String dataPath, <span class="keyword">final</span> Object data)</span> </span>&#123;</span><br><span class="line">                cacheRuleData((RuleData) data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataDeleted</span><span class="params">(<span class="keyword">final</span> String dataPath)</span> </span>&#123;</span><br><span class="line">                unCacheRuleData(dataPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribeAppAuthDataChanges</span><span class="params">(<span class="keyword">final</span> String realPath)</span> </span>&#123;</span><br><span class="line">        zkClient.subscribeDataChanges(realPath, <span class="keyword">new</span> IZkDataListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataChange</span><span class="params">(<span class="keyword">final</span> String dataPath, <span class="keyword">final</span> Object data)</span> </span>&#123;</span><br><span class="line">                cacheAuthData((AppAuthData) data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataDeleted</span><span class="params">(<span class="keyword">final</span> String dataPath)</span> </span>&#123;</span><br><span class="line">                unCacheAuthData(dataPath);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">subscribeMetaDataChanges</span><span class="params">(<span class="keyword">final</span> String realPath)</span> </span>&#123;</span><br><span class="line">        zkClient.subscribeDataChanges(realPath, <span class="keyword">new</span> IZkDataListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataChange</span><span class="params">(<span class="keyword">final</span> String dataPath, <span class="keyword">final</span> Object data)</span> </span>&#123;</span><br><span class="line">                cacheMetaData((MetaData) data);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@SneakyThrows</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDataDeleted</span><span class="params">(<span class="keyword">final</span> String dataPath)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> String realPath = dataPath.substring(ZkPathConstants.META_DATA.length() + <span class="number">1</span>);</span><br><span class="line">                MetaData metaData = <span class="keyword">new</span> MetaData();</span><br><span class="line">                metaData.setPath(URLDecoder.decode(realPath, StandardCharsets.UTF_8.name()));</span><br><span class="line">                unCacheMetaData(metaData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cachePluginData</span><span class="params">(<span class="keyword">final</span> PluginData pluginData)</span> </span>&#123;</span><br><span class="line">        Optional.ofNullable(pluginData).flatMap(data -&gt; Optional.ofNullable(pluginDataSubscriber)).ifPresent(e -&gt; e.onSubscribe(pluginData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheSelectorData</span><span class="params">(<span class="keyword">final</span> SelectorData selectorData)</span> </span>&#123;</span><br><span class="line">        Optional.ofNullable(selectorData)</span><br><span class="line">                .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onSelectorSubscribe(data)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unCacheSelectorData</span><span class="params">(<span class="keyword">final</span> String dataPath)</span> </span>&#123;</span><br><span class="line">        SelectorData selectorData = <span class="keyword">new</span> SelectorData();</span><br><span class="line">        <span class="keyword">final</span> String selectorId = dataPath.substring(dataPath.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">final</span> String str = dataPath.substring(ZkPathConstants.SELECTOR_PARENT.length());</span><br><span class="line">        <span class="keyword">final</span> String pluginName = str.substring(<span class="number">1</span>, str.length() - selectorId.length() - <span class="number">1</span>);</span><br><span class="line">        selectorData.setPluginName(pluginName);</span><br><span class="line">        selectorData.setId(selectorId);</span><br><span class="line">        Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.unSelectorSubscribe(selectorData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheRuleData</span><span class="params">(<span class="keyword">final</span> RuleData ruleData)</span> </span>&#123;</span><br><span class="line">        Optional.ofNullable(ruleData)</span><br><span class="line">                .ifPresent(data -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.onRuleSubscribe(data)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unCacheRuleData</span><span class="params">(<span class="keyword">final</span> String dataPath)</span> </span>&#123;</span><br><span class="line">        String substring = dataPath.substring(dataPath.lastIndexOf(<span class="string">&quot;/&quot;</span>) + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">final</span> String str = dataPath.substring(ZkPathConstants.RULE_PARENT.length());</span><br><span class="line">        <span class="keyword">final</span> String pluginName = str.substring(<span class="number">1</span>, str.length() - substring.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">final</span> List&lt;String&gt; list = Lists.newArrayList(Splitter.on(ZkPathConstants.SELECTOR_JOIN_RULE).split(substring));</span><br><span class="line">        RuleData ruleData = <span class="keyword">new</span> RuleData();</span><br><span class="line">        ruleData.setPluginName(pluginName);</span><br><span class="line">        ruleData.setSelectorId(list.get(<span class="number">0</span>));</span><br><span class="line">        ruleData.setId(list.get(<span class="number">1</span>));</span><br><span class="line">        Optional.ofNullable(pluginDataSubscriber).ifPresent(e -&gt; e.unRuleSubscribe(ruleData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheAuthData</span><span class="params">(<span class="keyword">final</span> AppAuthData appAuthData)</span> </span>&#123;</span><br><span class="line">        Optional.ofNullable(appAuthData).ifPresent(data -&gt; authDataSubscribers.forEach(e -&gt; e.onSubscribe(data)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unCacheAuthData</span><span class="params">(<span class="keyword">final</span> String dataPath)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String key = dataPath.substring(ZkPathConstants.APP_AUTH_PARENT.length() + <span class="number">1</span>);</span><br><span class="line">        AppAuthData appAuthData = <span class="keyword">new</span> AppAuthData();</span><br><span class="line">        appAuthData.setAppKey(key);</span><br><span class="line">        authDataSubscribers.forEach(e -&gt; e.unSubscribe(appAuthData));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheMetaData</span><span class="params">(<span class="keyword">final</span> MetaData metaData)</span> </span>&#123;</span><br><span class="line">        Optional.ofNullable(metaData).ifPresent(data -&gt; metaDataSubscribers.forEach(e -&gt; e.onSubscribe(metaData)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unCacheMetaData</span><span class="params">(<span class="keyword">final</span> MetaData metaData)</span> </span>&#123;</span><br><span class="line">        Optional.ofNullable(metaData).ifPresent(data -&gt; metaDataSubscribers.forEach(e -&gt; e.unSubscribe(metaData)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">addSubscribePath</span><span class="params">(<span class="keyword">final</span> List&lt;String&gt; alreadyChildren, <span class="keyword">final</span> List&lt;String&gt; currentChildren)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(alreadyChildren)) &#123;</span><br><span class="line">            <span class="keyword">return</span> currentChildren;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> currentChildren.stream().filter(current -&gt; alreadyChildren.stream().noneMatch(current::equals)).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">buildRealPath</span><span class="params">(<span class="keyword">final</span> String parent, <span class="keyword">final</span> String children)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parent + <span class="string">&quot;/&quot;</span> + children;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">zkClientGetChildren</span><span class="params">(<span class="keyword">final</span> String parent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!zkClient.exists(parent)) &#123;</span><br><span class="line">            zkClient.createPersistent(parent, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> zkClient.getChildren(parent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != zkClient) &#123;</span><br><span class="line">            zkClient.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-zookeeper-sync-data/" data-id="ckn5dfeoe000hqkvn3wsagnrm" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-websocket-sync-data" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-websocket-sync-data/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.567Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="soul网关推荐采用websocket方式同步数据，对比http长轮询方式有何优势？"><a href="#soul网关推荐采用websocket方式同步数据，对比http长轮询方式有何优势？" class="headerlink" title="soul网关推荐采用websocket方式同步数据，对比http长轮询方式有何优势？"></a>soul网关推荐采用websocket方式同步数据，对比http长轮询方式有何优势？</h2><ol>
<li>websocket方式能实时通知，而http长轮询方式只能做到准实时。</li>
<li>websocket同步采用增量处理，而http长轮询方式是全量数据，当数据量大的时候http长轮询方式就会有性能问题。</li>
</ol>
<h2 id="websocket同步方式详解"><a href="#websocket同步方式详解" class="headerlink" title="websocket同步方式详解"></a>websocket同步方式详解</h2><p>网关启动的时候注册WebSocketClient实例子类SoulWebsocketClient，此类负责与admin的websocket连接。数据同步业务全权委托给WebSocketDataHandler进行处理，符合单一职责原则，保持了此类的简单性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SoulWebsocketClient</span> <span class="keyword">extends</span> <span class="title">WebSocketClient</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> alreadySync = Boolean.FALSE;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> WebsocketDataHandler websocketDataHandler;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SoulWebsocketClient</span><span class="params">(<span class="keyword">final</span> URI serverUri, <span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">final</span> List&lt;MetaDataSubscriber&gt; metaDataSubscribers, <span class="keyword">final</span> List&lt;AuthDataSubscriber&gt; authDataSubscribers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(serverUri);</span><br><span class="line">        <span class="keyword">this</span>.websocketDataHandler = <span class="keyword">new</span> WebsocketDataHandler(pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onOpen</span><span class="params">(<span class="keyword">final</span> ServerHandshake serverHandshake)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!alreadySync) &#123;</span><br><span class="line">            send(DataEventTypeEnum.MYSELF.name());</span><br><span class="line">            alreadySync = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="keyword">final</span> String result)</span> </span>&#123;</span><br><span class="line">        handleResult(result);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;ALL&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleResult</span><span class="params">(<span class="keyword">final</span> String result)</span> </span>&#123;</span><br><span class="line">        WebsocketData websocketData = GsonUtils.getInstance().fromJson(result, WebsocketData.class);</span><br><span class="line">        ConfigGroupEnum groupEnum = ConfigGroupEnum.acquireByName(websocketData.getGroupType());</span><br><span class="line">        String eventType = websocketData.getEventType();</span><br><span class="line">        String json = GsonUtils.getInstance().toJson(websocketData.getData());</span><br><span class="line">        websocketDataHandler.executor(groupEnum, json, eventType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WebsocketDataHandler采用工厂模式，把PluginDataHandler、SelectorDataHandler、RuleDataHandler、AuthDataHandler、MetaDataHandler创建好，通过同步数据的类型自动匹配处理的逻辑，避免了令人生厌的if-else判断逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketDataHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> EnumMap&lt;ConfigGroupEnum, DataHandler&gt; ENUM_MAP = <span class="keyword">new</span> EnumMap&lt;&gt;(ConfigGroupEnum.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiates a new Websocket data handler.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pluginDataSubscriber the plugin data subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metaDataSubscribers  the meta data subscribers</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authDataSubscribers  the auth data subscribers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebsocketDataHandler</span><span class="params">(<span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">final</span> List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">final</span> List&lt;AuthDataSubscriber&gt; authDataSubscribers)</span> </span>&#123;</span><br><span class="line">        ENUM_MAP.put(ConfigGroupEnum.PLUGIN, <span class="keyword">new</span> PluginDataHandler(pluginDataSubscriber));</span><br><span class="line">        ENUM_MAP.put(ConfigGroupEnum.SELECTOR, <span class="keyword">new</span> SelectorDataHandler(pluginDataSubscriber));</span><br><span class="line">        ENUM_MAP.put(ConfigGroupEnum.RULE, <span class="keyword">new</span> RuleDataHandler(pluginDataSubscriber));</span><br><span class="line">        ENUM_MAP.put(ConfigGroupEnum.APP_AUTH, <span class="keyword">new</span> AuthDataHandler(authDataSubscribers));</span><br><span class="line">        ENUM_MAP.put(ConfigGroupEnum.META_DATA, <span class="keyword">new</span> MetaDataHandler(metaDataSubscribers));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Executor.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type      the type</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> json      the json</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> eventType the event type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">executor</span><span class="params">(<span class="keyword">final</span> ConfigGroupEnum type, <span class="keyword">final</span> String json, <span class="keyword">final</span> String eventType)</span> </span>&#123;</span><br><span class="line">        ENUM_MAP.get(type).handle(json, eventType);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>DataHandler负责数据的具体处理。而DataHandler只是一个接口，声明了一个handle方法。其余不同处理逻辑全由子类子具体负责。</p>
<p><img src="assets/20210120214026-dlgfz6o-PluginDataHandler.png" alt="PluginDataHandler.png"></p>
<p>AbstractDataHandler继承DataHandler，实现了通用的handle方法。并声明了convert、doRefresh、doUpdate、doDelete四个模板方法。这里就是经典设计模式中的模板模式了。而具体的Handler做的事情也非常简单，只是把数据变更通知订阅者而已。此处又使用了经典设计模式中的观察者模式。PluginDataHandler和其它handler一样。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PluginDataHandler</span> <span class="keyword">extends</span> <span class="title">AbstractDataHandler</span>&lt;<span class="title">PluginData</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;PluginData&gt; <span class="title">convert</span><span class="params">(<span class="keyword">final</span> String json)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> GsonUtils.getInstance().fromList(json, PluginData.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRefresh</span><span class="params">(<span class="keyword">final</span> List&lt;PluginData&gt; dataList)</span> </span>&#123;</span><br><span class="line">        pluginDataSubscriber.refreshPluginDataSelf(dataList);</span><br><span class="line">        dataList.forEach(pluginDataSubscriber::onSubscribe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doUpdate</span><span class="params">(<span class="keyword">final</span> List&lt;PluginData&gt; dataList)</span> </span>&#123;</span><br><span class="line">        dataList.forEach(pluginDataSubscriber::onSubscribe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDelete</span><span class="params">(<span class="keyword">final</span> List&lt;PluginData&gt; dataList)</span> </span>&#123;</span><br><span class="line">        dataList.forEach(pluginDataSubscriber::unSubscribe);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>订阅者收到数据变更通知后刷新本地缓存。以MetaDataAllSubscriber为例，做的事情很简单。就是缓存和删除缓存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MetaDataAllSubscriber</span> <span class="keyword">implements</span> <span class="title">MetaDataSubscriber</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(<span class="keyword">final</span> MetaData metaData)</span> </span>&#123;</span><br><span class="line">        MetaDataCache.getInstance().cache(metaData);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unSubscribe</span><span class="params">(<span class="keyword">final</span> MetaData metaData)</span> </span>&#123;</span><br><span class="line">        MetaDataCache.getInstance().remove(metaData);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而上述操作的上帝之手就是WebsocketSyncDataService。它根据配置的url数量创建WebSocketClient去连接admin。并开启定时任务检测连接是否断开，如果断开则重连。默认30秒检测一次。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketSyncDataService</span> <span class="keyword">implements</span> <span class="title">SyncDataService</span>, <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;WebSocketClient&gt; clients = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledThreadPoolExecutor executor;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiates a new Websocket sync cache.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> websocketConfig      the websocket config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pluginDataSubscriber the plugin data subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metaDataSubscribers  the meta data subscribers</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authDataSubscribers  the auth data subscribers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WebsocketSyncDataService</span><span class="params">(<span class="keyword">final</span> WebsocketConfig websocketConfig,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">final</span> List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span></span><br><span class="line"><span class="function"><span class="params">                                    <span class="keyword">final</span> List&lt;AuthDataSubscriber&gt; authDataSubscribers)</span> </span>&#123;</span><br><span class="line">        String[] urls = StringUtils.split(websocketConfig.getUrls(), <span class="string">&quot;,&quot;</span>);</span><br><span class="line">        executor = <span class="keyword">new</span> ScheduledThreadPoolExecutor(urls.length, SoulThreadFactory.create(<span class="string">&quot;websocket-connect&quot;</span>, <span class="keyword">true</span>));</span><br><span class="line">        <span class="keyword">for</span> (String url : urls) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clients.add(<span class="keyword">new</span> SoulWebsocketClient(<span class="keyword">new</span> URI(url), Objects.requireNonNull(pluginDataSubscriber), metaDataSubscribers, authDataSubscribers));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;websocket url(&#123;&#125;) is error&quot;</span>, url, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (WebSocketClient client : clients) &#123;</span><br><span class="line">                <span class="keyword">boolean</span> success = client.connectBlocking(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">                <span class="keyword">if</span> (success) &#123;</span><br><span class="line">                    log.info(<span class="string">&quot;websocket connection is successful.....&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;websocket connection is error.....&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                executor.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (client.isClosed()) &#123;</span><br><span class="line">                            <span class="keyword">boolean</span> reconnectSuccess = client.reconnectBlocking();</span><br><span class="line">                            <span class="keyword">if</span> (reconnectSuccess) &#123;</span><br><span class="line">                                log.info(<span class="string">&quot;websocket reconnect is successful.....&quot;</span>);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                log.error(<span class="string">&quot;websocket reconnection is error.....&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;websocket connect is error :&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="number">10</span>, <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">/* client.setProxy(new Proxy(Proxy.Type.HTTP, new InetSocketAddress(&quot;proxyaddress&quot;, 80)));*/</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;websocket connection...exception....&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (WebSocketClient client : clients) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!client.isClosed()) &#123;</span><br><span class="line">                client.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Objects.nonNull(executor)) &#123;</span><br><span class="line">            executor.shutdown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>admin这边由WebsocketCollector来维持websocket的连接。当网关刚启动的时候会发送一个MYSELF的消息，admin收到后变发送全量数据进行第一次同步。而后的消息变化就会是增量的同步。从而在数据量大的情况也也依然保证同步的高性能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketCollector</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Session&gt; SESSION_SET = <span class="keyword">new</span> CopyOnWriteArraySet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Session session;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * On message.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message the message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> session the session</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(<span class="keyword">final</span> String message, <span class="keyword">final</span> Session session)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (message.equals(DataEventTypeEnum.MYSELF.name())) &#123;</span><br><span class="line">            WebsocketCollector.session = session;</span><br><span class="line">            SpringBeanUtils.getInstance().getBean(SyncDataService.class).syncAll(DataEventTypeEnum.MYSELF);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> message the message</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type    the type</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(<span class="keyword">final</span> String message, <span class="keyword">final</span> DataEventTypeEnum type)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isNotBlank(message)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (DataEventTypeEnum.MYSELF == type) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    session.getBasicRemote().sendText(message);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;websocket send result is exception: &quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (Session session : SESSION_SET) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    session.getBasicRemote().sendText(message);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;websocket send result is exception: &quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>admin通过spring事件通知机制，一旦有数据修改则触发事件。WebsocketDataChangedListener接收到数据变更通知后就给网关发送消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebsocketDataChangedListener</span> <span class="keyword">implements</span> <span class="title">DataChangedListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPluginChanged</span><span class="params">(<span class="keyword">final</span> List&lt;PluginData&gt; pluginDataList, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        WebsocketData&lt;PluginData&gt; websocketData =</span><br><span class="line">                <span class="keyword">new</span> WebsocketData&lt;&gt;(ConfigGroupEnum.PLUGIN.name(), eventType.name(), pluginDataList);</span><br><span class="line">        WebsocketCollector.send(GsonUtils.getInstance().toJson(websocketData), eventType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSelectorChanged</span><span class="params">(<span class="keyword">final</span> List&lt;SelectorData&gt; selectorDataList, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        WebsocketData&lt;SelectorData&gt; websocketData =</span><br><span class="line">                <span class="keyword">new</span> WebsocketData&lt;&gt;(ConfigGroupEnum.SELECTOR.name(), eventType.name(), selectorDataList);</span><br><span class="line">        WebsocketCollector.send(GsonUtils.getInstance().toJson(websocketData), eventType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRuleChanged</span><span class="params">(<span class="keyword">final</span> List&lt;RuleData&gt; ruleDataList, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        WebsocketData&lt;RuleData&gt; configData =</span><br><span class="line">                <span class="keyword">new</span> WebsocketData&lt;&gt;(ConfigGroupEnum.RULE.name(), eventType.name(), ruleDataList);</span><br><span class="line">        WebsocketCollector.send(GsonUtils.getInstance().toJson(configData), eventType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAppAuthChanged</span><span class="params">(<span class="keyword">final</span> List&lt;AppAuthData&gt; appAuthDataList, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        WebsocketData&lt;AppAuthData&gt; configData =</span><br><span class="line">                <span class="keyword">new</span> WebsocketData&lt;&gt;(ConfigGroupEnum.APP_AUTH.name(), eventType.name(), appAuthDataList);</span><br><span class="line">        WebsocketCollector.send(GsonUtils.getInstance().toJson(configData), eventType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMetaDataChanged</span><span class="params">(<span class="keyword">final</span> List&lt;MetaData&gt; metaDataList, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        WebsocketData&lt;MetaData&gt; configData =</span><br><span class="line">                <span class="keyword">new</span> WebsocketData&lt;&gt;(ConfigGroupEnum.META_DATA.name(), eventType.name(), metaDataList);</span><br><span class="line">        WebsocketCollector.send(GsonUtils.getInstance().toJson(configData), eventType);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>就这样，soul网关就完成了websocket方式的数据同步。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-websocket-sync-data/" data-id="ckn5dfeod000gqkvn2uct2d2f" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-sync-data" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-sync-data/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.556Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="soul数据同步"><a href="#soul数据同步" class="headerlink" title="soul数据同步"></a>soul数据同步</h2><p>数据同步是指将 soul-admin 配置的数据，同步到 soul集群中的JVM内存里面，是网关高性能的关键。</p>
<h2 id="soul支持同步方式"><a href="#soul支持同步方式" class="headerlink" title="soul支持同步方式"></a>soul支持同步方式</h2><ol>
<li>websocket同步（默认方式，推荐）</li>
<li>zookeeper同步</li>
<li>http长轮询同步</li>
<li>nacos同步</li>
</ol>
<h4 id="同步数据的类图"><a href="#同步数据的类图" class="headerlink" title="同步数据的类图"></a>同步数据的类图</h4><p><img src="assets/20210119210918-hyfuzy6-HttpLongPollingDataChangedListener.png" alt="HttpLongPollingDataChangedListener.png"></p>
<p>DataChangedListener作为数据变化的顶级接口声明了授权、插件、选择器、元数据、规则数据变化的默认方法。DataChangedListener总共有4个子类，分别是AbstractDataChangedListener、NacosDataChangedListener、ZookeeperDataChangedListener、WebsocketDataChangedListener，分别对应着4种同步方式。</p>
<h2 id="http长轮询同步核心类详解"><a href="#http长轮询同步核心类详解" class="headerlink" title="http长轮询同步核心类详解"></a>http长轮询同步核心类详解</h2><p><img src="assets/20210119220426-wi9y2gb-HttpLongPollingDataChangedListener.png" alt="HttpLongPollingDataChangedListener.png"></p>
<p>AbstractDataChangedListener实现了DataChangedListener、InitializingBean接口。相对较简单，主要作用是维护admin配置数据缓存ConcurrentMap&lt;String, ConfigDataCache&gt; CACHE。而http长轮询的实现关键在其子类HttpLongPollingDataChangedListener。</p>
<p><img src="assets/20210119221421-rbfl2pw-HttpLongPollingDataChangedListener.png" alt="HttpLongPollingDataChangedListener.png"></p>
<p>HttpLongPollingDataChangedListener详细说明如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpLongPollingDataChangedListener</span> <span class="keyword">extends</span> <span class="title">AbstractDataChangedListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    ......省略</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock LOCK = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">    <span class="comment">// 维护长轮询连接阻塞队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;LongPollingClient&gt; clients;</span><br><span class="line">    <span class="comment">// 调度线程池</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduler;</span><br><span class="line">    <span class="comment">// 刷新缓存配置</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HttpSyncProperties httpSyncProperties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// bean初始化后启动定时任务，默认5分钟刷新一次缓存</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterInitialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> syncInterval = httpSyncProperties.getRefreshInterval().toMillis();</span><br><span class="line">        <span class="comment">// Periodically check the data for changes and update the cache</span></span><br><span class="line">        scheduler.scheduleWithFixedDelay(() -&gt; &#123;</span><br><span class="line">            log.info(<span class="string">&quot;http sync strategy refresh config start.&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">this</span>.refreshLocalCache();</span><br><span class="line">                log.info(<span class="string">&quot;http sync strategy refresh config success.&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;http sync strategy refresh config error!&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, syncInterval, syncInterval, TimeUnit.MILLISECONDS);</span><br><span class="line">        log.info(<span class="string">&quot;http sync strategy refresh interval: &#123;&#125;ms&quot;</span>, syncInterval);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshLocalCache</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.updateAppAuthCache();</span><br><span class="line">        <span class="keyword">this</span>.updatePluginCache();</span><br><span class="line">        <span class="keyword">this</span>.updateRuleCache();</span><br><span class="line">        <span class="keyword">this</span>.updateSelectorCache();</span><br><span class="line">        <span class="keyword">this</span>.updateMetaDataCache();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 比较数是否有变化，如果有变化立即响应，如果没有变化则使用Servlet3.0异步响应技术，先把请求放入阻塞队列，</span></span><br><span class="line">    <span class="comment">// 设定60秒后调度。60秒后不管有没有数据变化都进行响应，并移除这个请求。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doLongPolling</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request, <span class="keyword">final</span> HttpServletResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// compare group md5</span></span><br><span class="line">        List&lt;ConfigGroupEnum&gt; changedGroup = compareChangedGroup(request);</span><br><span class="line">        String clientIp = getRemoteIp(request);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// response immediately.</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(changedGroup)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.generateResponse(response, changedGroup);</span><br><span class="line">            log.info(<span class="string">&quot;send response with the changed group, ip=&#123;&#125;, group=&#123;&#125;&quot;</span>, clientIp, changedGroup);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// listen for configuration changed.</span></span><br><span class="line">        <span class="keyword">final</span> AsyncContext asyncContext = request.startAsync();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AsyncContext.settimeout() does not timeout properly, so you have to control it yourself</span></span><br><span class="line">        asyncContext.setTimeout(<span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// block client&#x27;s thread.</span></span><br><span class="line">        scheduler.execute(<span class="keyword">new</span> LongPollingClient(asyncContext, clientIp, HttpConstants.SERVER_MAX_HOLD_TIMEOUT));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果授权数据有变化，则响应通知变化并移除所有的长链接请求。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterAppAuthChanged</span><span class="params">(<span class="keyword">final</span> List&lt;AppAuthData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        scheduler.execute(<span class="keyword">new</span> DataChangeTask(ConfigGroupEnum.APP_AUTH));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果元数据有变化，则响应通知变化并移除所有的长链接请求。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterMetaDataChanged</span><span class="params">(<span class="keyword">final</span> List&lt;MetaData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        scheduler.execute(<span class="keyword">new</span> DataChangeTask(ConfigGroupEnum.META_DATA));</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 如果插件数据有变化，则响应通知变化并移除所有的长链接请求。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterPluginChanged</span><span class="params">(<span class="keyword">final</span> List&lt;PluginData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        scheduler.execute(<span class="keyword">new</span> DataChangeTask(ConfigGroupEnum.PLUGIN));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果规则数据有变化，则响应通知变化并移除所有的长链接请求。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterRuleChanged</span><span class="params">(<span class="keyword">final</span> List&lt;RuleData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        scheduler.execute(<span class="keyword">new</span> DataChangeTask(ConfigGroupEnum.RULE));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果选择器数据有变化，则响应通知变化并移除所有的长链接请求。</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">afterSelectorChanged</span><span class="params">(<span class="keyword">final</span> List&lt;SelectorData&gt; changed, <span class="keyword">final</span> DataEventTypeEnum eventType)</span> </span>&#123;</span><br><span class="line">        scheduler.execute(<span class="keyword">new</span> DataChangeTask(ConfigGroupEnum.SELECTOR));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 取出网关数据修改时间戳和md5值比较数据是否有变化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;ConfigGroupEnum&gt; <span class="title">compareChangedGroup</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        List&lt;ConfigGroupEnum&gt; changedGroup = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">4</span>);</span><br><span class="line">        <span class="keyword">for</span> (ConfigGroupEnum group : ConfigGroupEnum.values()) &#123;</span><br><span class="line">            <span class="comment">// md5,lastModifyTime</span></span><br><span class="line">            String[] params = StringUtils.split(request.getParameter(group.name()), <span class="string">&#x27;,&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (params == <span class="keyword">null</span> || params.length != <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SoulException(<span class="string">&quot;group param invalid:&quot;</span> + request.getParameter(group.name()));</span><br><span class="line">            &#125;</span><br><span class="line">            String clientMd5 = params[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">long</span> clientModifyTime = NumberUtils.toLong(params[<span class="number">1</span>]);</span><br><span class="line">            ConfigDataCache serverCache = CACHE.get(group.name());</span><br><span class="line">            <span class="comment">// do check.</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.checkCacheDelayAndUpdate(serverCache, clientMd5, clientModifyTime)) &#123;</span><br><span class="line">                changedGroup.add(group);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> changedGroup;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对比时间戳和md5值，如果有变化则返回true，无变化则返回false。</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkCacheDelayAndUpdate</span><span class="params">(<span class="keyword">final</span> ConfigDataCache serverCache, <span class="keyword">final</span> String clientMd5, <span class="keyword">final</span> <span class="keyword">long</span> clientModifyTime)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// is the same, doesn&#x27;t need to be updated</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.equals(clientMd5, serverCache.getMd5())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if the md5 value is different, it is necessary to compare lastModifyTime.</span></span><br><span class="line">        <span class="keyword">long</span> lastModifyTime = serverCache.getLastModifyTime();</span><br><span class="line">        <span class="keyword">if</span> (lastModifyTime &gt;= clientModifyTime) &#123;</span><br><span class="line">            <span class="comment">// the client&#x27;s config is out of date.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// the lastModifyTime before client, then the local cache needs to be updated.</span></span><br><span class="line">        <span class="comment">// Considering the concurrency problem, admin must lock,</span></span><br><span class="line">        <span class="comment">// otherwise it may cause the request from soul-web to update the cache concurrently, causing excessive db pressure</span></span><br><span class="line">        <span class="keyword">boolean</span> locked = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            locked = LOCK.tryLock(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (locked) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ConfigDataCache latest = CACHE.get(serverCache.getGroup());</span><br><span class="line">                <span class="keyword">if</span> (latest != serverCache) &#123;</span><br><span class="line">                    <span class="comment">// the cache of admin was updated. if the md5 value is the same, there&#x27;s no need to update.</span></span><br><span class="line">                    <span class="keyword">return</span> !StringUtils.equals(clientMd5, latest.getMd5());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// load cache from db.</span></span><br><span class="line">                <span class="keyword">this</span>.refreshLocalCache();</span><br><span class="line">                latest = CACHE.get(serverCache.getGroup());</span><br><span class="line">                <span class="keyword">return</span> !StringUtils.equals(clientMd5, latest.getMd5());</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                LOCK.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// not locked, the client need to be updated.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Send response datagram.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> response      the response</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> changedGroups the changed groups</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateResponse</span><span class="params">(<span class="keyword">final</span> HttpServletResponse response, <span class="keyword">final</span> List&lt;ConfigGroupEnum&gt; changedGroups)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            response.setHeader(<span class="string">&quot;Pragma&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">            response.setDateHeader(<span class="string">&quot;Expires&quot;</span>, <span class="number">0</span>);</span><br><span class="line">            response.setHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache,no-store&quot;</span>);</span><br><span class="line">            response.setContentType(MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">            response.setStatus(HttpServletResponse.SC_OK);</span><br><span class="line">            response.getWriter().println(GsonUtils.getInstance().toJson(SoulAdminResult.success(SoulResultMessage.SUCCESS, changedGroups)));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Sending response failed.&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据变化任务，当数据有变化就会提交该任务到线程池，并发响应和移除长轮询链接</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DataChangeTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The Group where the data has changed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ConfigGroupEnum groupKey;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The Change time.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> changeTime = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Instantiates a new Data change task.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> groupKey the group key</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        DataChangeTask(<span class="keyword">final</span> ConfigGroupEnum groupKey) &#123;</span><br><span class="line">            <span class="keyword">this</span>.groupKey = groupKey;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (Iterator&lt;LongPollingClient&gt; iter = clients.iterator(); iter.hasNext();) &#123;</span><br><span class="line">                LongPollingClient client = iter.next();</span><br><span class="line">                iter.remove();</span><br><span class="line">                client.sendResponse(Collections.singletonList(groupKey));</span><br><span class="line">                log.info(<span class="string">&quot;send response with the changed group,ip=&#123;&#125;, group=&#123;&#125;, changeTime=&#123;&#125;&quot;</span>, client.ip, groupKey, changeTime);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 长链接保持类。长链接60秒后调度，响应并移除。</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">LongPollingClient</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The Async context.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AsyncContext asyncContext;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The Ip.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String ip;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The Timeout time.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeoutTime;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * The Async timeout future.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> Future&lt;?&gt; asyncTimeoutFuture;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Instantiates a new Long polling client.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ac          the ac</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> ip          the ip</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> timeoutTime the timeout time</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        LongPollingClient(<span class="keyword">final</span> AsyncContext ac, <span class="keyword">final</span> String ip, <span class="keyword">final</span> <span class="keyword">long</span> timeoutTime) &#123;</span><br><span class="line">            <span class="keyword">this</span>.asyncContext = ac;</span><br><span class="line">            <span class="keyword">this</span>.ip = ip;</span><br><span class="line">            <span class="keyword">this</span>.timeoutTime = timeoutTime;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.asyncTimeoutFuture = scheduler.schedule(() -&gt; &#123;</span><br><span class="line">                clients.remove(LongPollingClient.<span class="keyword">this</span>);</span><br><span class="line">                List&lt;ConfigGroupEnum&gt; changedGroups = compareChangedGroup((HttpServletRequest) asyncContext.getRequest());</span><br><span class="line">                sendResponse(changedGroups);</span><br><span class="line">            &#125;, timeoutTime, TimeUnit.MILLISECONDS);</span><br><span class="line">            clients.add(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * Send response.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> changedGroups the changed groups</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">sendResponse</span><span class="params">(<span class="keyword">final</span> List&lt;ConfigGroupEnum&gt; changedGroups)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// cancel scheduler</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != asyncTimeoutFuture) &#123;</span><br><span class="line">                asyncTimeoutFuture.cancel(<span class="keyword">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            generateResponse((HttpServletResponse) asyncContext.getResponse(), changedGroups);</span><br><span class="line">            asyncContext.complete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="疑问：为何缓存数据为变化还要去数据库中刷新一次数据？"><a href="#疑问：为何缓存数据为变化还要去数据库中刷新一次数据？" class="headerlink" title="疑问：为何缓存数据为变化还要去数据库中刷新一次数据？"></a>疑问：为何缓存数据为变化还要去数据库中刷新一次数据？</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// the lastModifyTime before client, then the local cache needs to be updated.</span></span><br><span class="line"><span class="comment">// Considering the concurrency problem, admin must lock,</span></span><br><span class="line"><span class="comment">// otherwise it may cause the request from soul-web to update the cache concurrently, causing excessive db pressure</span></span><br><span class="line"><span class="keyword">boolean</span> locked = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    locked = LOCK.tryLock(<span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (locked) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ConfigDataCache latest = CACHE.get(serverCache.getGroup());</span><br><span class="line">        <span class="keyword">if</span> (latest != serverCache) &#123;</span><br><span class="line">            <span class="comment">// the cache of admin was updated. if the md5 value is the same, there&#x27;s no need to update.</span></span><br><span class="line">            <span class="keyword">return</span> !StringUtils.equals(clientMd5, latest.getMd5());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// load cache from db.</span></span><br><span class="line">        <span class="keyword">this</span>.refreshLocalCache();</span><br><span class="line">        latest = CACHE.get(serverCache.getGroup());</span><br><span class="line">        <span class="keyword">return</span> !StringUtils.equals(clientMd5, latest.getMd5());</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        LOCK.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-sync-data/" data-id="ckn5dfeob000fqkvnacemcskb" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-sofa-run" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-sofa-run/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.546Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="什么是sofa-rpc？"><a href="#什么是sofa-rpc？" class="headerlink" title="什么是sofa-rpc？"></a>什么是sofa-rpc？</h4><p>sofa-rpc 最早源于阿里内部的 HSF，是近期蚂蚁金服开源的一个高可扩展性、高性能、生产级的 Java RPC 框架。sofa-rpc 在蚂蚁金服已经历了十多年的发展，致力于简化应用之间的 RPC 调用。为应用提供方便透明、稳定高效的点对点远程服务调用方案。为了用户和开发者方便的进行功能扩展，SOFA-RPC 提供了丰富的模型抽象和可扩展接口，包括过滤器、路由、负载均衡等。同时围绕 SOFA-RPC 框架及其周边组件提供丰富的微服务治理方案。</p>
<h4 id="sofa-rpc功能特性"><a href="#sofa-rpc功能特性" class="headerlink" title="sofa-rpc功能特性"></a>sofa-rpc功能特性</h4><ul>
<li>透明化、高性能的远程服务调用</li>
<li>支持多种服务路由及负载均衡策略</li>
<li>支持多种注册中心的集成</li>
<li>支持 bolt、rest、dubbo 等多种通信协议</li>
<li>支持同步、单向、回调、泛化等多种调用方式</li>
<li>支持集群容错、服务预热、自动故障隔离</li>
<li>强大的扩展功能，可以按需扩展各个功能组件</li>
</ul>
<h4 id="sofa服务接入soul网关"><a href="#sofa服务接入soul网关" class="headerlink" title="sofa服务接入soul网关"></a>sofa服务接入soul网关</h4><ul>
<li>引入soul对sofa的支持依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soul-spring-boot-starter-client-sofa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;soul.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>增加发布网关的配置</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">soul:</span><br><span class="line">  sofa:</span><br><span class="line">    adminUrl: http://localhost:9095</span><br><span class="line">    contextPath: /sofa</span><br><span class="line">    appName: sofa</span><br></pre></td></tr></table></figure>

<ul>
<li>给需要发布到网关的接口增加注解@SoulSofaClient</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SoulSofaClient(path = &quot;/findById&quot;, desc = &quot;Find by Id&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DubboTest <span class="title">findById</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</span><br><span class="line">    DubboTest dubboTest = <span class="keyword">new</span> DubboTest();</span><br><span class="line">    dubboTest.setId(id);</span><br><span class="line">    dubboTest.setName(<span class="string">&quot;hello world Soul Sofa, findById&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> dubboTest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SoulSofaClient(path = &quot;/findAll&quot;, desc = &quot;Get all data&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DubboTest <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    DubboTest dubboTest = <span class="keyword">new</span> DubboTest();</span><br><span class="line">    dubboTest.setName(<span class="string">&quot;hello world Soul Sofa , findAll&quot;</span>);</span><br><span class="line">    dubboTest.setId(String.valueOf(<span class="keyword">new</span> Random().nextInt()));</span><br><span class="line">    <span class="keyword">return</span> dubboTest;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SoulSofaClient(path = &quot;/insert&quot;, desc = &quot;Insert a row of data&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DubboTest <span class="title">insert</span><span class="params">(<span class="keyword">final</span> DubboTest dubboTest)</span> </span>&#123;</span><br><span class="line">    dubboTest.setName(<span class="string">&quot;hello world Soul Sofa: &quot;</span> + dubboTest.getName());</span><br><span class="line">    <span class="keyword">return</span> dubboTest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>启动sofa应用发布到soul中</li>
<li>网关中开启sofa插件</li>
</ul>
<p><img src="assets/20210117004645-tg0ks42-1.png" alt="1.png"></p>
<ul>
<li>通过网关调用sofa服务</li>
</ul>
<p><img src="assets/20210117004744-qa3ce3y-2.png" alt="2.png"></p>
<p>坑！发现调不通，神奇，debug查看，sofa插件并未加载，所以响应了空</p>
<p><img src="assets/20210117004909-irmbv9c-3.png" alt="3.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-sofa-run/" data-id="ckn5dfeo9000dqkvn5myaek0k" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/06/soul-http-client-register/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/04/06/soul-global-plugin/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/04/06/soul-dubbo-run/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/04/06/soul-dubbo-plugin/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/04/06/soul-divide-plugin/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>