<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-soul-rate_limiter-plugin-03" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-rate_limiter-plugin-03/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.536Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>上一篇了解了<code>RateLimiter</code>插件的执行流程。讲到soul基于redis实现的令牌桶，是通过lua脚本实现。这篇我们就再细谈令牌桶算法。</p>
<h2 id="令牌桶算法由来"><a href="#令牌桶算法由来" class="headerlink" title="令牌桶算法由来"></a>令牌桶算法由来</h2><p>令牌桶算法最初来源于计算机网络。在网络传输数据时，为了防止网络拥塞，需限制流出网络的流量，使流量以比较均匀的速度向外发送。令牌桶算法就实现了这个功能，可控制发送到网络上数据的数目，并允许突发数据的发送。令牌桶算法是网络流量整形（Traffic Shaping）和速率限制（Rate Limiting）中最常使用的一种算法。典型情况下，令牌桶算法用来控制发送到网络上的数据的数目，并允许突发数据的发送。大小固定的令牌桶可自行以恒定的速率源源不断地产生令牌。如果令牌不被消耗，或者被消耗的速度小于产生的速度，令牌就会不断地增多，直到把桶填满。后面再产生的令牌就会从桶中溢出。最后桶中可以保存的最大令牌数永远不会超过桶的大小。传送到令牌桶的数据包需要消耗令牌。不同大小的数据包，消耗的令牌数量不一样。令牌桶这种控制机制基于令牌桶中是否存在令牌来指示什么时候可以发送流量。令牌桶中的每一个令牌都代表一个字节。如果令牌桶中存在令牌，则允许发送流量；而如果令牌桶中不存在令牌，则不允许发送流量。因此，如果突发门限被合理地配置并且令牌桶中有足够的令牌，那么流量就可以以峰值速率发送。</p>
<h2 id="令牌桶算详细描述"><a href="#令牌桶算详细描述" class="headerlink" title="令牌桶算详细描述"></a>令牌桶算详细描述</h2><p>首先令牌桶算法涉及到两个最重要的参数填充速率（rate）、令牌桶最大容量（capacity）。假如rate=r，capacity=c：</p>
<ol>
<li>每隔1/c秒就会产生一个令牌放入令牌桶中，也就是每秒放入c个令牌。</li>
<li>如果消费令牌的速率小于产生令牌的速率，当令牌桶中的令牌满了，也就是数量到达了c，那么新产生的令牌将会被丢弃。</li>
<li>不同的数据包需要消耗不同数量的令牌。如果有n个字节的数据包到达时，就从令牌桶中删除n个令牌。</li>
<li>如果令牌桶中的令牌数量小于n，不会删除令牌,该数据包先缓存或者丢弃。</li>
<li>当有突发流量来了，最多能处理c个字节。</li>
</ol>
<h2 id="令牌桶实现要点"><a href="#令牌桶实现要点" class="headerlink" title="令牌桶实现要点"></a>令牌桶实现要点</h2><ol>
<li>记录最大令牌桶容量、当前剩余令牌数量、下次可填充令牌的时间。</li>
<li>响应完一个请求之后并计算下次可填充令牌的时间，如果下一个请求在这个时间之前则需要等待。如果设置rate为1，那么要处理这个请求就得在一秒之后了。</li>
<li>支持突发流量的处理，且最大突发流量为令牌桶的最大容量。如果rate设置为1，capacity为10，如果10秒内没有消耗令牌，则如果有突发流量到来，则一下子可以获取到10个令牌。</li>
</ol>
<h2 id="令牌生产方式"><a href="#令牌生产方式" class="headerlink" title="令牌生产方式"></a>令牌生产方式</h2><ol>
<li>通过定时任务填充。此方式有明显的劣势，定时任务需要消耗系统资源，如果需要维护很多令牌桶，则消耗巨大。</li>
<li>延迟生成。在每次获取令牌的时候进行一次计算，计算下次可填充令牌时间到当前时间的间隔内可产生的令牌数量，并更令牌桶。</li>
</ol>
<h2 id="RateLimiter具体实现"><a href="#RateLimiter具体实现" class="headerlink" title="RateLimiter具体实现"></a><code>RateLimiter</code>具体实现</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">// 令牌桶key</span><br><span class="line"><span class="keyword">local</span> tokens_key = KEYS[<span class="number">1</span>]</span><br><span class="line">// 可填充令牌时间key</span><br><span class="line"><span class="keyword">local</span> timestamp_key = KEYS[<span class="number">2</span>]</span><br><span class="line">// 填充速率</span><br><span class="line"><span class="keyword">local</span> rate = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line">// 令牌桶最大容量</span><br><span class="line"><span class="keyword">local</span> capacity = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line">// 请求令牌时间</span><br><span class="line"><span class="keyword">local</span> now = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</span><br><span class="line">// 请求令牌数量</span><br><span class="line"><span class="keyword">local</span> requested = <span class="built_in">tonumber</span>(ARGV[<span class="number">4</span>])</span><br><span class="line">// 填充满整个令牌桶所需要的时间</span><br><span class="line"><span class="keyword">local</span> fill_time = capacity/rate</span><br><span class="line">// 令牌可累计的时长</span><br><span class="line"><span class="keyword">local</span> ttl = <span class="built_in">math</span>.<span class="built_in">floor</span>(fill_time*<span class="number">2</span>)</span><br><span class="line">// 查询出令牌桶当前剩余的令牌数量，没有则为<span class="number">0</span></span><br><span class="line"><span class="keyword">local</span> last_tokens = <span class="built_in">tonumber</span>(redis.call(<span class="string">&quot;get&quot;</span>, tokens_key))</span><br><span class="line"><span class="keyword">if</span> last_tokens == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">  last_tokens = capacity</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">// 查询可填充令牌时间，没有则为<span class="number">0</span></span><br><span class="line"><span class="keyword">local</span> last_refreshed = <span class="built_in">tonumber</span>(redis.call(<span class="string">&quot;get&quot;</span>, timestamp_key))</span><br><span class="line"><span class="keyword">if</span> last_refreshed == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">  last_refreshed = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">// 计算可填充令牌时间到当前时间的间隔，如果本次请求在可填充令牌时间之前，则为<span class="number">0</span></span><br><span class="line"><span class="keyword">local</span> delta = <span class="built_in">math</span>.<span class="built_in">max</span>(<span class="number">0</span>, now-last_refreshed)</span><br><span class="line">// 计算出令牌数量=剩余令牌+间隔时间内可生成的令牌数量，不能超过令牌桶最大容量</span><br><span class="line"><span class="keyword">local</span> filled_tokens = <span class="built_in">math</span>.<span class="built_in">min</span>(capacity, last_tokens+(delta*rate))</span><br><span class="line">// 判断当前请求是否令牌数量是否足够</span><br><span class="line"><span class="keyword">local</span> allowed = filled_tokens &gt;= requested</span><br><span class="line"><span class="keyword">local</span> new_tokens = filled_tokens</span><br><span class="line"><span class="keyword">local</span> allowed_num = <span class="number">0</span></span><br><span class="line">// 如果足够则删除请求的令牌数量</span><br><span class="line"><span class="keyword">if</span> allowed <span class="keyword">then</span></span><br><span class="line">  new_tokens = filled_tokens - requested</span><br><span class="line">  allowed_num = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">// 更新令牌桶</span><br><span class="line">redis.call(<span class="string">&quot;setex&quot;</span>, tokens_key, ttl, new_tokens)</span><br><span class="line">redis.call(<span class="string">&quot;setex&quot;</span>, timestamp_key, ttl, now)</span><br><span class="line">// 响应令牌请求结果，<span class="number">0</span>表示未获得令牌，<span class="number">1</span>表示成功获得令牌</span><br><span class="line"><span class="keyword">return</span> &#123; allowed_num, new_tokens &#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>使用lua操作redis实现令牌桶算法，利用redis单线程操作内存的特性式使其具有原子性保持高性能。</li>
<li>rate、capacity、nextFreeTicketMillis是整个算法的核心。尤其nextFreeTicketMillis比较拗口。</li>
<li><code>soul RateLimiter</code>采用延迟生成令牌的方式，避免定时任务的消耗。</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-rate_limiter-plugin-03/" data-id="ckn5dfeoa000eqkvn0g13d8te" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-rate_limiter-plugin-02" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-rate_limiter-plugin-02/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.529Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>上一篇我们已经了解了<code>RateLimiter</code>插件的大致原理和使用方法。今天我们再从微观层面再来探个究竟。</p>
<p>请求来了以后由<code>SoulWebHandler</code>进行进行处理，把封装请求信息的对象ServerWebExchange放入</p>
<p><code>DefaultSoulPluginChain</code>职责链中按照插件排序逐一进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(<span class="meta">@NonNull</span> <span class="keyword">final</span> ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">    MetricsTrackerFacade.getInstance().counterInc(MetricsLabelEnum.REQUEST_TOTAL.getName());</span><br><span class="line">    Optional&lt;HistogramMetricsTrackerDelegate&gt; startTimer = MetricsTrackerFacade.getInstance().histogramStartTimer(MetricsLabelEnum.REQUEST_LATENCY.getName());</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultSoulPluginChain(plugins).execute(exchange).subscribeOn(scheduler)</span><br><span class="line">            .doOnSuccess(t -&gt; startTimer.ifPresent(time -&gt; MetricsTrackerFacade.getInstance().histogramObserveDuration(time)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先是执行插件抽象基类<code>AbstractSoulPlugin</code>的execute方法做统一的一些处理。校验插件是否配置、插件是否开启、选择器是否配置、选择器是否开启、选取匹配的选择器、规则是否配置、选取匹配的规则。不过指定一提的是，这里设计得很棒，选择器、规则都是通过SPI的方式进行加载，可直接扩展。一切准备就绪，最核心的地方来了。选取好的选择器数据、规则数据传给子类<code>RateLimiterPlugin</code>，执行核心方法doExecute。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Mono&lt;Void&gt; <span class="title">doExecute</span><span class="params">(<span class="keyword">final</span> ServerWebExchange exchange, <span class="keyword">final</span> SoulPluginChain chain, <span class="keyword">final</span> SelectorData selector, <span class="keyword">final</span> RuleData rule)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String handle = rule.getHandle();</span><br><span class="line">    <span class="keyword">final</span> RateLimiterHandle limiterHandle = GsonUtils.getInstance().fromJson(handle, RateLimiterHandle.class);</span><br><span class="line">    <span class="keyword">return</span> redisRateLimiter.isAllowed(rule.getId(), limiterHandle.getReplenishRate(), limiterHandle.getBurstCapacity())</span><br><span class="line">            .flatMap(response -&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> (!response.isAllowed()) &#123;</span><br><span class="line">                    exchange.getResponse().setStatusCode(HttpStatus.TOO_MANY_REQUESTS);</span><br><span class="line">                    Object error = SoulResultWrap.error(SoulResultEnum.TOO_MANY_REQUESTS.getCode(), SoulResultEnum.TOO_MANY_REQUESTS.getMsg(), <span class="keyword">null</span>);</span><br><span class="line">                    <span class="keyword">return</span> WebFluxResultUtils.result(exchange, error);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> chain.execute(exchange);</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还记得上一篇文章说到<code>rateLimiter</code>插件的两个信息配置参数：</p>
<p><strong>rate：是你允许用户每秒执行多少请求，而丢弃任何请求。这是令牌桶的填充速率。</strong></p>
<p>capacity：是允许用户在一秒钟内执行的最大请求数。这是令牌桶可以保存的令牌数。</p>
<p>这里从json反序列化出来放到了RateLimiterHandle对象中进行使用。我看到，这两个参数直接传给了<code>RedisRateLimiter</code>的isAllowed方法。如果调用后返回信息<code>RateLimiterResponse</code>的allowed为true，那么就表示获取到了令牌，请求可以通过，继续执行下一个插件，否则中断处理直接响应结果。</p>
<p>那么isAllowed方法做了什么呢？继续往下探究。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Mono&lt;RateLimiterResponse&gt; <span class="title">isAllowed</span><span class="params">(<span class="keyword">final</span> String id, <span class="keyword">final</span> <span class="keyword">double</span> replenishRate, <span class="keyword">final</span> <span class="keyword">double</span> burstCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.initialized.get()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;RedisRateLimiter is not initialized&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;String&gt; keys = getKeys(id);</span><br><span class="line">    List&lt;String&gt; scriptArgs = Arrays.asList(replenishRate + <span class="string">&quot;&quot;</span>, burstCapacity + <span class="string">&quot;&quot;</span>, Instant.now().getEpochSecond() + <span class="string">&quot;&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    Flux&lt;List&lt;Long&gt;&gt; resultFlux = Singleton.INST.get(ReactiveRedisTemplate.class).execute(<span class="keyword">this</span>.script, keys, scriptArgs);</span><br><span class="line">    <span class="keyword">return</span> resultFlux.onErrorResume(throwable -&gt; Flux.just(Arrays.asList(<span class="number">1L</span>, -<span class="number">1L</span>)))</span><br><span class="line">            .reduce(<span class="keyword">new</span> ArrayList&lt;Long&gt;(), (longs, l) -&gt; &#123;</span><br><span class="line">                longs.addAll(l);</span><br><span class="line">                <span class="keyword">return</span> longs;</span><br><span class="line">            &#125;).map(results -&gt; &#123;</span><br><span class="line">                <span class="keyword">boolean</span> allowed = results.get(<span class="number">0</span>) == <span class="number">1L</span>;</span><br><span class="line">                Long tokensLeft = results.get(<span class="number">1</span>);</span><br><span class="line">                RateLimiterResponse rateLimiterResponse = <span class="keyword">new</span> RateLimiterResponse(allowed, tokensLeft);</span><br><span class="line">                log.info(<span class="string">&quot;RateLimiter response:&#123;&#125;&quot;</span>, rateLimiterResponse.toString());</span><br><span class="line">                <span class="keyword">return</span> rateLimiterResponse;</span><br><span class="line">            &#125;).doOnError(throwable -&gt; log.error(<span class="string">&quot;Error determining if user allowed from redis:&#123;&#125;&quot;</span>, throwable.getMessage()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造一个redis keys数组：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">getKeys</span><span class="params">(<span class="keyword">final</span> String id)</span> </span>&#123;</span><br><span class="line">    String prefix = <span class="string">&quot;request_rate_limiter.&#123;&quot;</span> + id;</span><br><span class="line">    String tokenKey = prefix + <span class="string">&quot;&#125;.tokens&quot;</span>;</span><br><span class="line">    String timestampKey = prefix + <span class="string">&quot;&#125;.timestamp&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> Arrays.asList(tokenKey, timestampKey);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>redis脚本参数数组:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; scriptArgs = Arrays.asList(replenishRate + <span class="string">&quot;&quot;</span>, burstCapacity + <span class="string">&quot;&quot;</span>, Instant.now().getEpochSecond() + <span class="string">&quot;&quot;</span>, <span class="string">&quot;1&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>调用初始化的时候加载好的lua脚本：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RedisScript&lt;List&lt;Long&gt;&gt; redisScript() &#123;</span><br><span class="line">    DefaultRedisScript redisScript = <span class="keyword">new</span> DefaultRedisScript&lt;&gt;();</span><br><span class="line">    redisScript.setScriptSource(<span class="keyword">new</span> ResourceScriptSource(<span class="keyword">new</span> ClassPathResource(<span class="string">&quot;/META-INF/scripts/request_rate_limiter.lua&quot;</span>)));</span><br><span class="line">    redisScript.setResultType(List.class);</span><br><span class="line">    <span class="keyword">return</span> redisScript;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后把脚本的执行结果放入<code>RateLimiterResponse</code>返回。</p>
<p>由此看到，<code>RateLimiter</code>插件使用Redis实现了令牌桶算法，这就天然支持了分布式。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> tokens_key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> timestamp_key = KEYS[<span class="number">2</span>]</span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;tokens_key &quot; .. tokens_key)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> rate = <span class="built_in">tonumber</span>(ARGV[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">local</span> capacity = <span class="built_in">tonumber</span>(ARGV[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">local</span> now = <span class="built_in">tonumber</span>(ARGV[<span class="number">3</span>])</span><br><span class="line"><span class="keyword">local</span> requested = <span class="built_in">tonumber</span>(ARGV[<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> fill_time = capacity/rate</span><br><span class="line"><span class="keyword">local</span> ttl = <span class="built_in">math</span>.<span class="built_in">floor</span>(fill_time*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;rate &quot; .. ARGV[1])</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;capacity &quot; .. ARGV[2])</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;now &quot; .. ARGV[3])</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;requested &quot; .. ARGV[4])</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;filltime &quot; .. fill_time)</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;ttl &quot; .. ttl)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> last_tokens = <span class="built_in">tonumber</span>(redis.call(<span class="string">&quot;get&quot;</span>, tokens_key))</span><br><span class="line"><span class="keyword">if</span> last_tokens == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">  last_tokens = capacity</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;last_tokens &quot; .. last_tokens)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> last_refreshed = <span class="built_in">tonumber</span>(redis.call(<span class="string">&quot;get&quot;</span>, timestamp_key))</span><br><span class="line"><span class="keyword">if</span> last_refreshed == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">  last_refreshed = <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;last_refreshed &quot; .. last_refreshed)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> delta = <span class="built_in">math</span>.<span class="built_in">max</span>(<span class="number">0</span>, now-last_refreshed)</span><br><span class="line"><span class="keyword">local</span> filled_tokens = <span class="built_in">math</span>.<span class="built_in">min</span>(capacity, last_tokens+(delta*rate))</span><br><span class="line"><span class="keyword">local</span> allowed = filled_tokens &gt;= requested</span><br><span class="line"><span class="keyword">local</span> new_tokens = filled_tokens</span><br><span class="line"><span class="keyword">local</span> allowed_num = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> allowed <span class="keyword">then</span></span><br><span class="line">  new_tokens = filled_tokens - requested</span><br><span class="line">  allowed_num = <span class="number">1</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;delta &quot; .. delta)</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;filled_tokens &quot; .. filled_tokens)</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;allowed_num &quot; .. allowed_num)</span></span><br><span class="line"><span class="comment">--redis.log(redis.LOG_WARNING, &quot;new_tokens &quot; .. new_tokens)</span></span><br><span class="line"></span><br><span class="line">redis.call(<span class="string">&quot;setex&quot;</span>, tokens_key, ttl, new_tokens)</span><br><span class="line">redis.call(<span class="string">&quot;setex&quot;</span>, timestamp_key, ttl, now)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123; allowed_num, new_tokens &#125;</span><br></pre></td></tr></table></figure>

<p>至于这个令牌桶的具体脚本实现逻辑，我们且看下回分解。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-rate_limiter-plugin-02/" data-id="ckn5dfeo8000cqkvn2p4t17ho" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-rate_limiter-plugin-01" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-rate_limiter-plugin-01/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.522Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="RateLimiter插件"><a href="#RateLimiter插件" class="headerlink" title="RateLimiter插件"></a>RateLimiter插件</h2><p>限流插件，是网关对流量管控限制核心的实现。可以到接口级别，也可以到参数级别。</p>
<h2 id="技术方案"><a href="#技术方案" class="headerlink" title="技术方案"></a>技术方案</h2><p>采用redis令牌桶算法进行限流。</p>
<p><img src="assets/20210123223018-fa0q0ss-limiting.png" alt="limiting.png"></p>
<h2 id="什么是令牌桶算法"><a href="#什么是令牌桶算法" class="headerlink" title="什么是令牌桶算法?"></a>什么是令牌桶算法?</h2><p>令牌桶算法是一种限流算法，他与漏桶算法的实现是一种相反的实现。</p>
<p>漏桶算法是按照一定频率的速率进行漏水，然后对于我们的请求就可以想象成上边的水龙头。</p>
<p><img src="assets/20210123224741-eyjf3bv-00831rSTly1gdnjduhuivj30cb08b74u.jpg" alt="00831rSTly1gdnjduhuivj30cb08b74u.jpg"></p>
<p>令牌桶算法则是定时的往桶中放入令牌，然后每次请求都会从令牌桶中获取一个令牌，如果桶中没有令牌，则拒绝请求或者阻塞直到令牌可以获得。</p>
<p><img src="assets/20210123224827-hu1tklg-00831rSTly1gdnjhiarxgj30bp06pwek.jpg" alt="00831rSTly1gdnjhiarxgj30bp06pwek.jpg"></p>
<h2 id="牛刀小试"><a href="#牛刀小试" class="headerlink" title="牛刀小试"></a>牛刀小试</h2><ul>
<li>soul-examples-http中引入RateLimiter插件</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soul-spring-boot-starter-plugin-ratelimiter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;soul.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>启动redis并配置到RateLimiter插件中</li>
<li>admin中开启RateLimiter插件</li>
</ul>
<p><img src="assets/20210123225914-6aq1hcp-%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210123225355.png" alt="微信截图20210123225355.png"></p>
<ul>
<li>配置限流选择器和规则，两个重要的蚕食capacity、rate。</li>
</ul>
<p><strong>rate：是你允许用户每秒执行多少请求，而丢弃任何请求。这是令牌桶的填充速率。</strong></p>
<p><strong>capacity：是允许用户在一秒钟内执行的最大请求数。这是令牌桶可以保存的令牌数。</strong></p>
<p><img src="assets/20210123230000-t65v5sm-%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210123225640.png" alt="微信截图20210123225640.png"></p>
<ul>
<li>用jmeter压测一番，看看配置是否好用</li>
</ul>
<p><img src="assets/20210123230924-4raiu8r-%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210123230854.png" alt="微信截图20210123230854.png"></p>
<p>从图中可看到99.03%的错误率，且错误请求响应参数为</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">&quot;code&quot;</span>:<span class="number">429</span>,<span class="attr">&quot;message&quot;</span>:<span class="string">&quot;You have been restricted, please try again later!&quot;</span>,<span class="attr">&quot;data&quot;</span>:<span class="literal">null</span>&#125;</span><br></pre></td></tr></table></figure>

<p>看来配置确实生效了。那么容量调大点再压</p>
<p><img src="assets/20210123231710-d6ewkti-1113.png" alt="1113.png"></p>
<p><img src="assets/20210123231722-yah20mv-4441.png" alt="4441.png"></p>
<p>这下错误率直接降为26.49%了。就这么简单，一个限流的功能就整起来了，非常方便灵活，并且随时可以调整配置，这就是soul网关强大之处呀。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-rate_limiter-plugin-01/" data-id="ckn5dfeo7000bqkvnhlcya4br" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-nacos-sync-data" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-nacos-sync-data/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.514Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="soul-nacos方式同步数据原理"><a href="#soul-nacos方式同步数据原理" class="headerlink" title="soul nacos方式同步数据原理"></a>soul nacos方式同步数据原理</h2><p>soul nacos方式同步数据原理和zookeeper基本一致，都是利用中间件自身的监听机制。<code>soul-admin</code> 在启动的时候，会将数据全量写入 <code>nacos</code>，后续数据发生变更时，会增量更新 到<code>nacos</code> 。而启动的时候会从nacos中读取全量数据保存到本地并开启监听nacos中数据的变化。一旦<code>soul-admin</code>中数据有变化并更新到<code>nacos</code>中，<code>soul-web</code>即可收到<code>nacos</code>通知然后把变化的数据刷新到本地缓存。</p>
<h2 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h2><p>NacosSyncDataService类实现了数据同步统一接口SyncDataService，作用就是在构造方法中调用start方法从<code>nacos</code>中读取全量数据并增添监听器监听数据变化并通知订阅者缓存和刷新数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosSyncDataService</span> <span class="keyword">extends</span> <span class="title">NacosCacheHandler</span> <span class="keyword">implements</span> <span class="title">AutoCloseable</span>, <span class="title">SyncDataService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Instantiates a new Nacos sync data service.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> configService         the config service</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pluginDataSubscriber the plugin data subscriber</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> metaDataSubscribers   the meta data subscribers</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> authDataSubscribers   the auth data subscribers</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NacosSyncDataService</span><span class="params">(<span class="keyword">final</span> ConfigService configService, <span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">final</span> List&lt;MetaDataSubscriber&gt; metaDataSubscribers, <span class="keyword">final</span> List&lt;AuthDataSubscriber&gt; authDataSubscribers)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">super</span>(configService, pluginDataSubscriber, metaDataSubscribers, authDataSubscribers);</span><br><span class="line">        start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Start.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        watcherData(PLUGIN_DATA_ID, <span class="keyword">this</span>::updatePluginMap);</span><br><span class="line">        watcherData(SELECTOR_DATA_ID, <span class="keyword">this</span>::updateSelectorMap);</span><br><span class="line">        watcherData(RULE_DATA_ID, <span class="keyword">this</span>::updateRuleMap);</span><br><span class="line">        watcherData(META_DATA_ID, <span class="keyword">this</span>::updateMetaDataMap);</span><br><span class="line">        watcherData(AUTH_DATA_ID, <span class="keyword">this</span>::updateAuthMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        LISTENERS.forEach((dataId, lss) -&gt; &#123;</span><br><span class="line">            lss.forEach(listener -&gt; getConfigService().removeListener(dataId, GROUP, listener));</span><br><span class="line">            lss.clear();</span><br><span class="line">        &#125;);</span><br><span class="line">        LISTENERS.clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而实际操作都在其父类NacosCacheHandler中完成。watcherData负责添加监听器。并注册收到通知时候执行OnChange接口的change方法。具体就是在change方法中调用updatePluginMap、updateSelectorMap、updateRuleMap、updateMetaDataMap、updateAuthMap。具体操作就是通知订阅者先删除本地数据，再缓存新数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosCacheHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String GROUP = <span class="string">&quot;DEFAULT_GROUP&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String PLUGIN_DATA_ID = <span class="string">&quot;soul.plugin.json&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String SELECTOR_DATA_ID = <span class="string">&quot;soul.selector.json&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String RULE_DATA_ID = <span class="string">&quot;soul.rule.json&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTH_DATA_ID = <span class="string">&quot;soul.auth.json&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> String META_DATA_ID = <span class="string">&quot;soul.meta.json&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, List&lt;Listener&gt;&gt; LISTENERS = Maps.newConcurrentMap();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigService configService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;MetaDataSubscriber&gt; metaDataSubscribers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;AuthDataSubscriber&gt; authDataSubscribers;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NacosCacheHandler</span><span class="params">(<span class="keyword">final</span> ConfigService configService, <span class="keyword">final</span> PluginDataSubscriber pluginDataSubscriber,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">final</span> List&lt;MetaDataSubscriber&gt; metaDataSubscribers,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">final</span> List&lt;AuthDataSubscriber&gt; authDataSubscribers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.configService = configService;</span><br><span class="line">        <span class="keyword">this</span>.pluginDataSubscriber = pluginDataSubscriber;</span><br><span class="line">        <span class="keyword">this</span>.metaDataSubscribers = metaDataSubscribers;</span><br><span class="line">        <span class="keyword">this</span>.authDataSubscribers = authDataSubscribers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updatePluginMap</span><span class="params">(<span class="keyword">final</span> String configInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Fix bug #656(https://github.com/dromara/soul/issues/656)</span></span><br><span class="line">            List&lt;PluginData&gt; pluginDataList = <span class="keyword">new</span> ArrayList&lt;&gt;(GsonUtils.getInstance().toObjectMap(configInfo, PluginData.class).values());</span><br><span class="line">            pluginDataList.forEach(pluginData -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(subscriber -&gt; &#123;</span><br><span class="line">                subscriber.unSubscribe(pluginData);</span><br><span class="line">                subscriber.onSubscribe(pluginData);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonParseException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;sync plugin data have error:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateSelectorMap</span><span class="params">(<span class="keyword">final</span> String configInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;SelectorData&gt; selectorDataList = GsonUtils.getInstance().toObjectMapList(configInfo, SelectorData.class).values().stream().flatMap(Collection::stream).collect(Collectors.toList());</span><br><span class="line">            selectorDataList.forEach(selectorData -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(subscriber -&gt; &#123;</span><br><span class="line">                subscriber.unSelectorSubscribe(selectorData);</span><br><span class="line">                subscriber.onSelectorSubscribe(selectorData);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonParseException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;sync selector data have error:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateRuleMap</span><span class="params">(<span class="keyword">final</span> String configInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;RuleData&gt; ruleDataList = GsonUtils.getInstance().toObjectMapList(configInfo, RuleData.class).values()</span><br><span class="line">                    .stream().flatMap(Collection::stream)</span><br><span class="line">                    .collect(Collectors.toList());</span><br><span class="line">            ruleDataList.forEach(ruleData -&gt; Optional.ofNullable(pluginDataSubscriber).ifPresent(subscriber -&gt; &#123;</span><br><span class="line">                subscriber.unRuleSubscribe(ruleData);</span><br><span class="line">                subscriber.onRuleSubscribe(ruleData);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonParseException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;sync rule data have error:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateMetaDataMap</span><span class="params">(<span class="keyword">final</span> String configInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;MetaData&gt; metaDataList = <span class="keyword">new</span> ArrayList&lt;&gt;(GsonUtils.getInstance().toObjectMap(configInfo, MetaData.class).values());</span><br><span class="line">            metaDataList.forEach(metaData -&gt; metaDataSubscribers.forEach(subscriber -&gt; &#123;</span><br><span class="line">                subscriber.unSubscribe(metaData);</span><br><span class="line">                subscriber.onSubscribe(metaData);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonParseException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;sync meta data have error:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">updateAuthMap</span><span class="params">(<span class="keyword">final</span> String configInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            List&lt;AppAuthData&gt; appAuthDataList = <span class="keyword">new</span> ArrayList&lt;&gt;(GsonUtils.getInstance().toObjectMap(configInfo, AppAuthData.class).values());</span><br><span class="line">            appAuthDataList.forEach(appAuthData -&gt; authDataSubscribers.forEach(subscriber -&gt; &#123;</span><br><span class="line">                subscriber.unSubscribe(appAuthData);</span><br><span class="line">                subscriber.onSubscribe(appAuthData);</span><br><span class="line">            &#125;));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (JsonParseException e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;sync auth data have error:&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getConfigAndSignListener</span><span class="params">(<span class="keyword">final</span> String dataId, <span class="keyword">final</span> Listener listener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configService.getConfigAndSignListener(dataId, GROUP, <span class="number">6000</span>, listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">watcherData</span><span class="params">(<span class="keyword">final</span> String dataId, <span class="keyword">final</span> OnChange oc)</span> </span>&#123;</span><br><span class="line">        Listener listener = <span class="keyword">new</span> Listener() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveConfigInfo</span><span class="params">(<span class="keyword">final</span> String configInfo)</span> </span>&#123;</span><br><span class="line">                oc.change(configInfo);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        oc.change(getConfigAndSignListener(dataId, listener));</span><br><span class="line">        LISTENERS.getOrDefault(dataId, <span class="keyword">new</span> ArrayList&lt;&gt;()).add(listener);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">interface</span> <span class="title">OnChange</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">change</span><span class="params">(String changeData)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至于对<code>nacos</code>的操作全是通过ConfigService进行。这是<code>nacos</code>的api。<code>nacos</code>这个监听机制是通过http长轮询的方式，原理和<code>soul</code>的http长轮询方式一模一样。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-nacos-sync-data/" data-id="ckn5dfeo7000aqkvn7rmvfpst" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-hystrix-plugin-03" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-hystrix-plugin-03/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.504Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>上一篇我们看了一个Hystrix的入门例子，了解了Hystrix的工作流程。今天我们再来看看Hystrix的命令执行的方式、资源的隔离类型。</p>
<h2 id="执行命令的几种方法"><a href="#执行命令的几种方法" class="headerlink" title="执行命令的几种方法"></a>执行命令的几种方法</h2><p>Hystrix提供了4种执行命令的方法，execute()和queue() 适用于HystrixCommand对象，而observe()和toObservable()适用于HystrixObservableCommand对象。</p>
<p><strong>execute()</strong></p>
<p>以同步阻塞方式执行run()，只支持接收一个值对象。hystrix会从线程池中取一个线程来执行run()，并等待返回值。</p>
<p><strong>queue()</strong></p>
<p>以异步非阻塞方式执行run()，只支持接收一个值对象。调用queue()就直接返回一个Future对象。可通过 Future.get()拿到run()的返回结果，但Future.get()是阻塞执行的。若执行成功，Future.get()返回单个返回值。当执行失败时，如果没有重写fallback，Future.get()抛出异常。</p>
<p><strong>observe()</strong></p>
<p>事件注册前执行run()/construct()，支持接收多个值对象，取决于发射源。调用observe()会返回一个hot Observable，也就是说，调用observe()自动触发执行run()/construct()，无论是否存在订阅者。</p>
<p>如果继承的是HystrixCommand，hystrix会从线程池中取一个线程以非阻塞方式执行run()；如果继承的是HystrixObservableCommand，将以调用线程阻塞执行construct()</p>
<p>observe()使用方法：</p>
<ol>
<li>调用observe()会返回一个Observable对象</li>
<li>调用这个Observable对象的subscribe()方法完成事件注册，从而获取结果</li>
</ol>
<p><strong>toObservable()</strong></p>
<p>事件注册后执行run()/construct()，支持接收多个值对象，取决于发射源。调用toObservable()会返回一个cold Observable，也就是说，调用toObservable()不会立即触发执行run()/construct()，必须有订阅者订阅Observable时才会执行。</p>
<p>如果继承的是HystrixCommand，hystrix会从线程池中取一个线程以非阻塞方式执行run()，调用线程不必等待run()；如果继承的是HystrixObservableCommand，将以调用线程堵塞执行construct()，调用线程需等待construct()执行完才能继续往下走。</p>
<p>toObservable()使用方法：</p>
<ol>
<li>调用observe()会返回一个Observable对象</li>
<li>调用这个Observable对象的subscribe()方法完成事件注册，从而获取结果</li>
</ol>
<p>需注意的是，HystrixCommand也支持toObservable()和observe()，但是即使将HystrixCommand转换成Observable，它也只能发射一个值对象。只有HystrixObservableCommand才支持发射多个值对象。</p>
<p><strong>几种方法的关系</strong></p>
<ul>
<li>execute()实际是调用了queue().get()</li>
<li>queue()实际调用了toObservable().toBlocking().toFuture()</li>
<li>observe()实际调用toObservable()获得一个cold Observable，再创建一个ReplaySubject对象订阅Observable，将源Observable转化为hot Observable。因此调用observe()会自动触发执行run()/construct()。</li>
</ul>
<p>Hystrix总是以Observable的形式作为响应返回，不同执行命令的方法只是进行了相应的转换。</p>
<h2 id="Hystrix容错"><a href="#Hystrix容错" class="headerlink" title="Hystrix容错"></a>Hystrix容错</h2><p>Hystrix的容错主要是通过添加容许延迟和容错方法，帮助控制这些分布式服务之间的交互。 还通过隔离服务之间的访问点，阻止它们之间的级联故障以及提供回退选项来实现这一点，从而提高系统的整体弹性。Hystrix主要提供了以下几种容错方法：</p>
<ul>
<li>资源隔离</li>
<li>熔断</li>
<li>降级</li>
</ul>
<h2 id="资源隔离"><a href="#资源隔离" class="headerlink" title="资源隔离"></a>资源隔离</h2><p>资源隔离主要指对线程的隔离。Hystrix提供了两种线程隔离方式：线程池和信号量。</p>
<h3 id="线程隔离-线程池"><a href="#线程隔离-线程池" class="headerlink" title="线程隔离-线程池"></a><strong>线程隔离-线程池</strong></h3><p>Hystrix通过命令模式对发送请求的对象和执行请求的对象进行解耦，将不同类型的业务请求封装为对应的命令请求。Hystrix为每个类型的Command配置一个线程池，当第一次创建Command时，根据配置创建一个线程池，并放入ConcurrentHashMap。相同类型的Command将会重用已创建的线程池。通过将发送请求线程与执行请求的线程分离，可有效防止发生级联故障。当线程池或请求队列饱和时，Hystrix将拒绝服务，使得请求线程可以快速失败，从而避免依赖问题扩散。</p>
<h4 id="线程池隔离优缺点"><a href="#线程池隔离优缺点" class="headerlink" title="线程池隔离优缺点"></a><strong>线程池隔离优缺点</strong></h4><p><strong>优点：</strong></p>
<ul>
<li>保护应用程序以免受来自依赖故障的影响，指定依赖线程池饱和不会影响应用程序的其余部分。</li>
<li>当引入新客户端lib时，即使发生问题，也是在本lib中，并不会影响到其他内容。</li>
<li>当依赖从故障恢复正常时，应用程序会立即恢复正常的性能。</li>
<li>当应用程序一些配置参数错误时，线程池的运行状况会很快检测到这一点（通过增加错误，延迟，超时，拒绝等），同时可以通过动态属性进行实时纠正错误的参数配置。</li>
<li>如果服务的性能有变化，需要实时调整，比如增加或者减少超时时间，更改重试次数，可以通过线程池指标动态属性修改，而且不会影响到其他调用请求。</li>
<li>除了隔离优势外，hystrix拥有专门的线程池可提供内置的并发功能，使得可以在同步调用之上构建异步门面（外观模式），为异步编程提供了支持（Hystrix引入了Rxjava异步框架）。</li>
</ul>
<p>注意：尽管线程池提供了线程隔离，我们的客户端底层代码也必须要有超时设置或响应线程中断，不能无限制的阻塞以致线程池一直饱和。</p>
<p><strong>缺点：</strong></p>
<p>线程池的主要缺点是增加了计算开销。每个命令的执行都在单独的线程完成，增加了排队、调度和上下文切换的开销。因此，要使用Hystrix，就必须接受它带来的开销，以换取它所提供的好处。</p>
<p>通常情况下，线程池引入的开销足够小，不会有重大的成本或性能影响。但对于一些访问延迟极低的服务，如只依赖内存缓存，线程池引入的开销就比较明显了，这时候使用线程池隔离技术就不适合了，我们需要考虑更轻量级的方式，如信号量隔离。</p>
<h3 id="线程隔离-信号量"><a href="#线程隔离-信号量" class="headerlink" title="线程隔离-信号量"></a><strong>线程隔离-信号量</strong></h3><p>上面提到了线程池隔离的缺点，当依赖延迟极低的服务时，线程池隔离技术引入的开销超过了它所带来的好处。这时候可以使用信号量隔离技术来代替，通过设置信号量来限制对任何给定依赖的并发调用量。使用线程池时，发送请求的线程和执行依赖服务的线程不是同一个，而使用信号量时，发送请求的线程和执行依赖服务的线程是同一个，都是发起请求的线程。</p>
<p>由于Hystrix默认使用线程池做线程隔离，使用信号量隔离需要显示地将属性execution.isolation.strategy设置为ExecutionIsolationStrategy.SEMAPHORE，同时配置信号量个数，默认为10。客户端需向依赖服务发起请求时，首先要获取一个信号量才能真正发起调用，由于信号量的数量有限，当并发请求量超过信号量个数时，后续的请求都会直接拒绝，进入fallback流程。</p>
<p>信号量隔离主要是通过控制并发请求量，防止请求线程大面积阻塞，从而达到限流和防止雪崩的目的。</p>
<h3 id="资源隔离总结"><a href="#资源隔离总结" class="headerlink" title="资源隔离总结"></a>资源隔离总结</h3><p>线程池和信号量都支持熔断和限流。相比线程池，信号量不需要线程切换，因此避免了不必要的开销。但是信号量不支持异步，也不支持超时，也就是说当所请求的服务不可用时，信号量会控制超过限制的请求立即返回，但是已经持有信号量的线程只能等待服务响应或从超时中返回，即可能出现长时间等待。线程池模式下，当超过指定时间未响应的服务，Hystrix会通过响应中断的方式通知线程立即结束并返回。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-hystrix-plugin-03/" data-id="ckn5dfeo60009qkvn487of3fa" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-hystrix-plugin-02" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-hystrix-plugin-02/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.497Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>上一篇从宏观上认识了Hystrix，大体了解了Hystrix是什么，能解决什么问题。今天我们再从一个入门例子看起，看看具体怎么使用，过程怎么执行。</p>
<ul>
<li>继承HystrixCommand，进行简单的配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.netflix.hystrix.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsCommand</span> <span class="keyword">extends</span> <span class="title">HystrixCommand</span>&lt;<span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> GoodsService goodsService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">GoodsCommand</span><span class="params">(GoodsService goodsService)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(<span class="string">&quot;GoodsService&quot;</span>))</span><br><span class="line">                .andCommandKey(HystrixCommandKey.Factory.asKey(<span class="string">&quot;QueryGoodsById&quot;</span>))</span><br><span class="line">                .andCommandPropertiesDefaults(HystrixCommandProperties.Setter()</span><br><span class="line">                        <span class="comment">//至少有10个请求，熔断器才进行错误率的计算</span></span><br><span class="line">                        .withCircuitBreakerRequestVolumeThreshold(<span class="number">10</span>)</span><br><span class="line">                        <span class="comment">//熔断器中断请求5秒后会进入半打开状态,放部分流量过去重试</span></span><br><span class="line">                        .withCircuitBreakerSleepWindowInMilliseconds(<span class="number">5000</span>)</span><br><span class="line">                        <span class="comment">//错误率达到50开启熔断保护</span></span><br><span class="line">                        .withCircuitBreakerErrorThresholdPercentage(<span class="number">50</span>)</span><br><span class="line">                        .withExecutionTimeoutEnabled(<span class="keyword">true</span>))</span><br><span class="line">                .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties</span><br><span class="line">                        .Setter().withCoreSize(<span class="number">10</span>)));</span><br><span class="line">        <span class="keyword">this</span>.goodsService = goodsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Integer <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> goodsService.queryGoodsById();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Integer <span class="title">getFallback</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>实际请求对象的方法</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger id = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">queryGoodsById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id.incrementAndGet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>调用HystrixCommand的execute方法发起请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsCommandMain</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Integer r = <span class="keyword">new</span> GoodsCommand(<span class="keyword">new</span> GoodsService()).execute();</span><br><span class="line">        System.out.println(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="assets/20210130230824-sftkfix-Dingtalk_20210130230810.jpg" alt="Dingtalk20210130230810.jpg"></p>
<p>看到请求正常执行。</p>
<ul>
<li>熔断测试</li>
</ul>
<p>在queryGoodsById的前10个请求抛出异常进行测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GoodsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger id = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">queryGoodsById</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">200</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        id.incrementAndGet();</span><br><span class="line">        <span class="keyword">if</span> (id.get() &lt; <span class="number">10</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> id.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    GoodsService goodsService = <span class="keyword">new</span> GoodsService();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">        Integer r = <span class="keyword">new</span> GoodsCommand(goodsService).execute();</span><br><span class="line">        System.out.println(r);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">6000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">        Integer r = <span class="keyword">new</span> GoodsCommand(goodsService).execute();</span><br><span class="line">        System.out.println(<span class="string">&quot;--&gt;&quot;</span> + r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">23:25:14.686 [hystrix-GoodsService-9] DEBUG com.netflix.hystrix.AbstractCommand - Error executing HystrixCommand.run(). Proceeding to fallback logic ...</span><br><span class="line">java.lang.IllegalStateException: null</span><br><span class="line">	at io.zjh.hystrix.GoodsService.queryGoodsById(GoodsService.java:20)</span><br><span class="line">	at io.zjh.hystrix.GoodsCommand.run(GoodsCommand.java:27)</span><br><span class="line">	at io.zjh.hystrix.GoodsCommand.run(GoodsCommand.java:5)</span><br><span class="line">	at com.netflix.hystrix.HystrixCommand$2.call(HystrixCommand.java:302)</span><br><span class="line">	at com.netflix.hystrix.HystrixCommand$2.call(HystrixCommand.java:298)</span><br><span class="line">	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:46)</span><br><span class="line">	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35)</span><br><span class="line">	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)</span><br><span class="line">	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)</span><br><span class="line">	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)</span><br><span class="line">	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)</span><br><span class="line">	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)</span><br><span class="line">	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)</span><br><span class="line">	at rx.Observable.unsafeSubscribe(Observable.java:10327)</span><br><span class="line">	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:51)</span><br><span class="line">	at rx.internal.operators.OnSubscribeDefer.call(OnSubscribeDefer.java:35)</span><br><span class="line">	at rx.Observable.unsafeSubscribe(Observable.java:10327)</span><br><span class="line">	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:41)</span><br><span class="line">	at rx.internal.operators.OnSubscribeDoOnEach.call(OnSubscribeDoOnEach.java:30)</span><br><span class="line">	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:48)</span><br><span class="line">	at rx.internal.operators.OnSubscribeLift.call(OnSubscribeLift.java:30)</span><br><span class="line">	at rx.Observable.unsafeSubscribe(Observable.java:10327)</span><br><span class="line">	at rx.internal.operators.OperatorSubscribeOn$SubscribeOnSubscriber.call(OperatorSubscribeOn.java:100)</span><br><span class="line">	at com.netflix.hystrix.strategy.concurrency.HystrixContexSchedulerAction$1.call(HystrixContexSchedulerAction.java:56)</span><br><span class="line">	at com.netflix.hystrix.strategy.concurrency.HystrixContexSchedulerAction$1.call(HystrixContexSchedulerAction.java:47)</span><br><span class="line">	at com.netflix.hystrix.strategy.concurrency.HystrixContexSchedulerAction.call(HystrixContexSchedulerAction.java:69)</span><br><span class="line">	at rx.internal.schedulers.ScheduledAction.run(ScheduledAction.java:55)</span><br><span class="line">	at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)</span><br><span class="line">	at java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:266)</span><br><span class="line">	at java.util.concurrent.FutureTask.run(FutureTask.java)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)</span><br><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)</span><br><span class="line">	at java.lang.Thread.run(Thread.java:748)</span><br><span class="line">-1</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">-1</span><br><span class="line">-1</span><br><span class="line">-1</span><br><span class="line">-1</span><br><span class="line">-1</span><br><span class="line">-1</span><br><span class="line">-1</span><br><span class="line">-1</span><br><span class="line">--&gt;13</span><br><span class="line">--&gt;14</span><br><span class="line">--&gt;15</span><br><span class="line">--&gt;16</span><br><span class="line">--&gt;17</span><br><span class="line">--&gt;18</span><br><span class="line">--&gt;19</span><br><span class="line">--&gt;20</span><br><span class="line">--&gt;21</span><br></pre></td></tr></table></figure>

<p>从结果可以看到，前10次请求都因抛出异常而走到了fallback流程，直接返回了-1，然后过了3个请求，熔断器的统计数据开始发挥了作用，开始进行熔断了，直接快速失败走fallback。然后暂停6s中后继续发起请求，熔断器进入了半开状态，放行一个试探成功后，熔断器关闭，后续的请求就恢复正常了。</p>
<h2 id="总结：Hystrix工作流程"><a href="#总结：Hystrix工作流程" class="headerlink" title="总结：Hystrix工作流程"></a>总结：Hystrix工作流程</h2><p><img src="assets/20210130230413-7uyjlm5-%E4%B8%8B%E8%BD%BD.png" alt="下载.png"></p>
<ol>
<li>构造一个 HystrixCommand或HystrixObservableCommand对象，用于封装请求，并在构造方法配置请求被执行需要的参数；</li>
<li>执行命令；</li>
<li>判断是否使用缓存响应请求，若启用了缓存，且缓存可用，直接使用缓存响应请求。Hystrix支持请求缓存，但需要用户自定义启动；</li>
<li>判断熔断器是否打开，如果打开，跳到第8步；</li>
<li>判断线程池/队列/信号量是否已满，已满则跳到第8步；</li>
<li>执行HystrixObservableCommand.construct()或HystrixCommand.run()，如果执行失败或者超时，跳到第8步；否则，跳到第9步；</li>
<li>统计熔断器监控指标；</li>
<li>走Fallback备用逻辑</li>
<li>返回请求响应</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-hystrix-plugin-02/" data-id="ckn5dfeo50008qkvn8gmph3du" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-hystrix-plugin-01" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-hystrix-plugin-01/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.486Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>soul hystrix插件是网关用来对流量进行熔断的核心实现，使用的是信号量的方式来处理请求。</p>
<h2 id="什么是Hystrix？"><a href="#什么是Hystrix？" class="headerlink" title="什么是Hystrix？"></a>什么是Hystrix？</h2><p>在分布式环境中，不可避免地会有许多服务依赖项中的某些失败。Hystrix是一个库，可通过添加延迟公差和容错逻辑来帮助控制这些分布式服务之间的交互。Hystrix通过隔离服务之间的访问点，停止服务之间的级联故障并提供后备选项来实现此目的，所有这些都可以提高系统的整体弹性。</p>
<h2 id="Hystrix的作用是什么？"><a href="#Hystrix的作用是什么？" class="headerlink" title="Hystrix的作用是什么？"></a>Hystrix的作用是什么？</h2><ul>
<li>提供保护并控制延迟和失败，以及通过第三方客户端库（通常是通过网络）访问的依赖项的失败。</li>
<li>停止复杂的分布式系统中的级联故障。</li>
<li>快速失败并快速恢复。</li>
<li>回退并在可能的情况下正常降级。</li>
<li>启用近乎实时的监视，警报和操作控制。</li>
</ul>
<h2 id="Hystrix解决什么问题？"><a href="#Hystrix解决什么问题？" class="headerlink" title="Hystrix解决什么问题？"></a>Hystrix解决什么问题？</h2><p>复杂分布式体系结构中的应用程序具有数十种依赖关系，每种依赖关系不可避免地会在某个时刻失败。如果主机应用程序未与这些外部故障隔离开来，则会收到影响甚至拖垮。</p>
<p>当一切正常时，请求流如下所示：</p>
<p><img src="assets/20210129221251-ro5b9qf-soa-1-640.png" alt="soa1640.png"></p>
<p>当许多后端系统之一变得潜在时，它可以阻止整个用户请求：</p>
<p><img src="assets/20210129221417-5oler0x-soa-2-640.png" alt="soa2640.png"></p>
<p>随着高流量，单个后端依赖关系变得潜在，这可能导致所有服务器上的所有资源在几秒钟内变得饱和。</p>
<p>应用程序中可能会导致网络请求的，通过网络或客户端库延伸的每个点都是潜在故障的根源。比故障更糟糕的是，这些应用程序还会导致服务之间的等待时间增加，从而备份队列，线程和其他系统资源，从而导致整个系统出现更多级联故障。</p>
<p><img src="assets/20210129221629-i1bcn6h-soa-3-640.png" alt="soa3640.png"></p>
<p>当通过第三方客户端执行网络访问时，这些问题会更加严重。“第三方”是一个隐藏了实施细节的“黑匣子”，可以随时更改，并且每个客户端库的网络或资源配置都不相同，并且通常难以监视和监控。更改。</p>
<p>更糟糕的是，传递依赖项会执行潜在的昂贵或易出错的网络调用，而不会被应用程序明确调用。</p>
<p>网络连接失败或降级。服务和服务器出现故障或变慢。新的库或服务部署会更改行为或性能特征。客户端库有错误。</p>
<p>所有这些都代表需要隔离和管理的故障和延迟，以使单个故障依赖项无法关闭整个应用程序或系统。</p>
<h2 id="Hystrix的设计原则是什么？"><a href="#Hystrix的设计原则是什么？" class="headerlink" title="Hystrix的设计原则是什么？"></a>Hystrix的设计原则是什么？</h2><ul>
<li>防止任何单个依赖项耗尽所有容器（例如Tomcat）用户线程。</li>
<li>减少负载并快速失败，而不是排队。</li>
<li>在可行的情况下提供备用，以保护用户免受故障的影响。</li>
<li>使用隔离技术（例如隔板，泳道和断路器模式）来限制任何一种依赖关系的影响。</li>
<li>通过近实时指标，监视和警报优化发现时间</li>
<li>通过在Hystrix的大多数方面中以低延迟传播配置更改来优化恢复时间，并支持动态属性更改，这可以通过低延迟反馈回路进行实时操作修改。</li>
<li>防止整个依赖项客户端执行失败，而不仅仅是网络流量失败。</li>
</ul>
<h2 id="Hystrix如何实现其目标？"><a href="#Hystrix如何实现其目标？" class="headerlink" title="Hystrix如何实现其目标？"></a>Hystrix如何实现其目标？</h2><ul>
<li>将对外部系统（或“依赖项”）的所有调用包装在通常在单独线程中执行的<code>HystrixCommand</code>或<code>HystrixObservableCommand</code>对象中（这是<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Command_pattern">命令模式</a>的示例）。</li>
<li>超时呼叫花费的时间超过您定义的阈值。有一个默认值，但是对于大多数依赖项，您可以通过“属性”自定义设置这些超时，以使它们略高于针对每个依赖项测得的99.5个百分点的性能。</li>
<li>为每个依赖项维护一个小的线程池（或信号灯）；如果已满，发往该依赖项的请求将立即被拒绝，而不是排队。</li>
<li>测量成功，失败（客户端抛出的异常），超时和线程拒绝。</li>
<li>如果某个服务的错误百分比超过阈值，则使断路器跳闸，以在一段时间内手动或自动停止所有对特定服务的请求。</li>
<li>当请求失败，被拒绝，超时或短路时执行回退逻辑。</li>
<li>几乎实时监控指标和配置更改。</li>
</ul>
<h2 id="使用Hystrix后的系统"><a href="#使用Hystrix后的系统" class="headerlink" title="使用Hystrix后的系统"></a>使用Hystrix后的系统</h2><p><img src="assets/20210129222225-9vtj0c7-soa-4-isolation-640.png" alt="soa4isolation640.png"></p>
<p>当使用Hystrix封装每个基础依赖项时，每个依赖项都是相互隔离的，受到延迟时发生饱和的资源的限制，并包含回退逻辑，该逻辑决定了在依赖项中发生任何类型的故障时做出什么响应。</p>
<h2 id="soul-中如何使用Hystrix插件"><a href="#soul-中如何使用Hystrix插件" class="headerlink" title="soul 中如何使用Hystrix插件"></a>soul 中如何使用Hystrix插件</h2><ul>
<li>网关中引入依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.dromara<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>soul-spring-boot-starter-plugin-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;last.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>开启插件，配置选择器、规则</li>
</ul>
<p><img src="assets/20210129231901-dcf7ysi-image.png" alt="image.png"></p>
<ul>
<li>模拟一个超时请求</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/findByUserId&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDTO <span class="title">findByUserId</span><span class="params">(<span class="meta">@RequestParam(&quot;userId&quot;)</span> <span class="keyword">final</span> String userId)</span> </span>&#123;</span><br><span class="line">    UserDTO userDTO = <span class="keyword">new</span> UserDTO();</span><br><span class="line">    userDTO.setUserId(userId);</span><br><span class="line">    userDTO.setUserName(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> userDTO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>请求接口获得响应，发现已经执行了降级处理</li>
</ul>
<p><img src="assets/20210129232041-oyhupoy-image.png" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-hystrix-plugin-01/" data-id="ckn5dfeo20005qkvndwdb7tvk" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-http-sync-data" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-http-sync-data/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:38.474Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="soul数据同步"><a href="#soul数据同步" class="headerlink" title="soul数据同步"></a>soul数据同步</h2><p>数据同步是指将 <code>soul-admin</code> 配置的数据，同步到 <code>soul</code> 集群中的JVM内存里面，当请求到来后只需从本地获取配置信息即可，这是网关高性能的关键。为了这种高性能，就需要维护网关本地内存中的配置与admin的配置保持同步。</p>
<h2 id="soul数据同步的原理"><a href="#soul数据同步的原理" class="headerlink" title="soul数据同步的原理"></a>soul数据同步的原理</h2><p><code>Soul</code> 数据同步的流程，<code>Soul</code> 网关在启动时，会从从配置服务同步配置数据，并且支持推拉模式获取配置变更信息，并且更新本地缓存。而管理员在管理后台，变更用户、规则、插件、流量配置，通过推拉模式将变更信息同步给 <code>Soul</code> 网关，具体是 <code>push</code> 模式，还是 <code>pull</code> 模式取决于配置。关于配置同步模块，其实是一个简版的配置中心。</p>
<p><img src="assets/20210118222948-0rv9uqm-soul-config-processor.png" alt="soulconfigprocessor.png"></p>
<h2 id="http长轮询原理"><a href="#http长轮询原理" class="headerlink" title="http长轮询原理"></a>http长轮询原理</h2><p>Soul 借鉴了 <code>Apollo</code>、<code>Nacos</code> 的设计思想，取其精华，自己实现了 <code>http</code> 长轮询数据同步功能。注意，这里并非传统的 ajax 长轮询！</p>
<p><img src="assets/20210118223118-0m151vq-http-long-polling.png" alt="httplongpolling.png"></p>
<p>http 长轮询机制如上所示，soul-web 网关请求 admin 的配置服务，读取超时时间为 90s，意味着网关层请求配置服务最多会等待 90s，这样便于 admin 配置服务及时响应变更数据，从而实现准实时推送。</p>
<p>http 请求到达 sou-admin 之后，并非立马响应数据，而是利用 Servlet3.0 的异步机制，异步响应数据。首先，将长轮询请求任务 <code>LongPollingClient</code> 扔到 <code>BlocingQueue</code> 中，并且开启调度任务，60s 后执行，这样做的目的是 60s 后将该长轮询请求移除队列，即便是这段时间内没有发生配置数据变更。因为即便是没有配置变更，也得让网关知道，总不能让其干等吧，而且网关请求配置服务时，也有 90s 的超时时间。如果这段时间内，管理员变更了配置数据，此时，会挨个移除队列中的长轮询请求，并响应数据，告知是哪个 Group 的数据发生了变更。网关收到响应信息之后，只知道是哪个 Group 发生了配置变更，还需要再次请求该 Group 的配置数据。为什么不是直接将变更的数据写出？因为 http 长轮询机制只能保证准实时，如果在网关层处理不及时，或者管理员频繁更新配置，很有可能便错过了某个配置变更的推送，安全起见，只告知某个 Group 信息发生了变更。</p>
<h2 id="http长轮询流程"><a href="#http长轮询流程" class="headerlink" title="http长轮询流程"></a>http长轮询流程</h2><ul>
<li>打开admin http数据同步开关</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">soul:</span><br><span class="line">  sync:</span><br><span class="line">      http:</span><br><span class="line">        enabled: true</span><br></pre></td></tr></table></figure>

<ul>
<li>也相应打开网关中http数据同步的开关</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">soul:</span><br><span class="line">    sync:</span><br><span class="line">        http:</span><br><span class="line">             url: http://localhost:9095</span><br></pre></td></tr></table></figure>

<ul>
<li>admin这端主要是HttpLongPollingDataChangedListener，该类是http长轮询的核心类,具体负责调度网关长轮询任务，缓存的刷新和推送变更通知以及响应配置数据。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSyncConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http long polling(default strategy).</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Configuration</span></span><br><span class="line">    <span class="meta">@ConditionalOnProperty(name = &quot;soul.sync.http.enabled&quot;, havingValue = &quot;true&quot;)</span></span><br><span class="line">    <span class="meta">@EnableConfigurationProperties(HttpSyncProperties.class)</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpLongPollingListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean(HttpLongPollingDataChangedListener.class)</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> HttpLongPollingDataChangedListener <span class="title">httpLongPollingDataChangedListener</span><span class="params">(<span class="keyword">final</span> HttpSyncProperties httpSyncProperties)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> HttpLongPollingDataChangedListener(httpSyncProperties);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>网关启动的时候注册HttpSyncDataService服务，然后在构造方法中调用了start方法开始到admin拉取数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="comment">// It could be initialized multiple times, so you need to control that.</span></span><br><span class="line">       <span class="keyword">if</span> (RUNNING.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">           <span class="comment">// fetch all group configs.</span></span><br><span class="line">           <span class="keyword">this</span>.fetchGroupConfig(ConfigGroupEnum.values());</span><br><span class="line">           <span class="keyword">int</span> threadSize = serverList.size();</span><br><span class="line">           <span class="keyword">this</span>.executor = <span class="keyword">new</span> ThreadPoolExecutor(threadSize, threadSize, <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                   <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;(),</span><br><span class="line">                   SoulThreadFactory.create(<span class="string">&quot;http-long-polling&quot;</span>, <span class="keyword">true</span>));</span><br><span class="line">           <span class="comment">// start long polling, each server creates a thread to listen for changes.</span></span><br><span class="line">           <span class="keyword">this</span>.serverList.forEach(server -&gt; <span class="keyword">this</span>.executor.execute(<span class="keyword">new</span> HttpLongPollingTask(server)));</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           log.info(<span class="string">&quot;soul http long polling was started, executor=[&#123;&#125;]&quot;</span>, executor);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>start方法主要干两件事，第一件事是在配置的一堆admin服务器循环去调用admin的/configs/fetch接口拉取全量的数据，如果拉取到了数据，则中断循环。如果循环结束还未拉取到，那么网关就没法启动了。没有配置的网关启动也毫无意义。拉取到配置数据后挨个组去判断数据的md5以及修改时间，如果md5不同且修改时间比本地配置数据修改时间更晚，说明配置需要更新则刷新本地缓存。否则都无变化则等待30s。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">private void fetchGroupConfig(final ConfigGroupEnum... groups) throws SoulException &#123;</span><br><span class="line">       for (int index &#x3D; 0; index &lt; this.serverList.size(); index++) &#123;</span><br><span class="line">           String server &#x3D; serverList.get(index);</span><br><span class="line">           try &#123;</span><br><span class="line">               this.doFetchGroupConfig(server, groups);</span><br><span class="line">               break;</span><br><span class="line">           &#125; catch (SoulException e) &#123;</span><br><span class="line">               &#x2F;&#x2F; no available server, throw exception.</span><br><span class="line">               if (index &gt;&#x3D; serverList.size() - 1) &#123;</span><br><span class="line">                   throw e;</span><br><span class="line">               &#125;</span><br><span class="line">               log.warn(&quot;fetch config fail, try another one: &#123;&#125;&quot;, serverList.get(index + 1));</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   private void doFetchGroupConfig(final String server, final ConfigGroupEnum... groups) &#123;</span><br><span class="line">       StringBuilder params &#x3D; new StringBuilder();</span><br><span class="line">       for (ConfigGroupEnum groupKey : groups) &#123;</span><br><span class="line">           params.append(&quot;groupKeys&quot;).append(&quot;&#x3D;&quot;).append(groupKey.name()).append(&quot;&amp;&quot;);</span><br><span class="line">       &#125;</span><br><span class="line">       String url &#x3D; server + &quot;&#x2F;configs&#x2F;fetch?&quot; + StringUtils.removeEnd(params.toString(), &quot;&amp;&quot;);</span><br><span class="line">       log.info(&quot;request configs: [&#123;&#125;]&quot;, url);</span><br><span class="line">       String json &#x3D; null;</span><br><span class="line">       try &#123;</span><br><span class="line">           json &#x3D; this.httpClient.getForObject(url, String.class);</span><br><span class="line">       &#125; catch (RestClientException e) &#123;</span><br><span class="line">           String message &#x3D; String.format(&quot;fetch config fail from server[%s], %s&quot;, url, e.getMessage());</span><br><span class="line">           log.warn(message);</span><br><span class="line">           throw new SoulException(message, e);</span><br><span class="line">       &#125;</span><br><span class="line">       &#x2F;&#x2F; update local cache</span><br><span class="line">       boolean updated &#x3D; this.updateCacheWithJson(json);</span><br><span class="line">       if (updated) &#123;</span><br><span class="line">           log.info(&quot;get latest configs: [&#123;&#125;]&quot;, json);</span><br><span class="line">           return;</span><br><span class="line">       &#125;</span><br><span class="line">       &#x2F;&#x2F; not updated. it is likely that the current config server has not been updated yet. wait a moment.</span><br><span class="line">       log.info(&quot;The config of the server[&#123;&#125;] has not been updated or is out of date. Wait for 30s to listen for changes again.&quot;, server);</span><br><span class="line">       ThreadUtils.sleep(TimeUnit.SECONDS, 30);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>第二件事就是往线程池中提交和admin服务数量相同的长轮询任务,一直调用doLongPolling方法去监听admin数据变化。具体就是调用admin端的/configs/listener接口。一旦admin有数据变更则会响应回来，当收到具体哪些组数据变更后，则调用doFetchGroupConfig真正去拉取变化组的配置数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HttpLongPollingTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> String server;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> retryTimes = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">      HttpLongPollingTask(<span class="keyword">final</span> String server) &#123;</span><br><span class="line">          <span class="keyword">this</span>.server = server;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">while</span> (RUNNING.get()) &#123;</span><br><span class="line">              <span class="keyword">for</span> (<span class="keyword">int</span> time = <span class="number">1</span>; time &lt;= retryTimes; time++) &#123;</span><br><span class="line">                  <span class="keyword">try</span> &#123;</span><br><span class="line">                      doLongPolling(server);</span><br><span class="line">                  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                      <span class="comment">// print warnning log.</span></span><br><span class="line">                      <span class="keyword">if</span> (time &lt; retryTimes) &#123;</span><br><span class="line">                          log.warn(<span class="string">&quot;Long polling failed, tried &#123;&#125; times, &#123;&#125; times left, will be suspended for a while! &#123;&#125;&quot;</span>,</span><br><span class="line">                                  time, retryTimes - time, e.getMessage());</span><br><span class="line">                          ThreadUtils.sleep(TimeUnit.SECONDS, <span class="number">5</span>);</span><br><span class="line">                          <span class="keyword">continue</span>;</span><br><span class="line">                      &#125;</span><br><span class="line">                      <span class="comment">// print error, then suspended for a while.</span></span><br><span class="line">                      log.error(<span class="string">&quot;Long polling failed, try again after 5 minutes!&quot;</span>, e);</span><br><span class="line">                      ThreadUtils.sleep(TimeUnit.MINUTES, <span class="number">5</span>);</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          log.warn(<span class="string">&quot;Stop http long polling.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doLongPolling</span><span class="params">(<span class="keyword">final</span> String server)</span> </span>&#123;</span><br><span class="line">    MultiValueMap&lt;String, String&gt; params = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">    <span class="keyword">for</span> (ConfigGroupEnum group : ConfigGroupEnum.values()) &#123;</span><br><span class="line">        ConfigData&lt;?&gt; cacheConfig = factory.cacheConfigData(group);</span><br><span class="line">        String value = String.join(<span class="string">&quot;,&quot;</span>, cacheConfig.getMd5(), String.valueOf(cacheConfig.getLastModifyTime()));</span><br><span class="line">        params.put(group.name(), Lists.newArrayList(value));</span><br><span class="line">    &#125;</span><br><span class="line">    HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span><br><span class="line">    headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class="line">    HttpEntity httpEntity = <span class="keyword">new</span> HttpEntity(params, headers);</span><br><span class="line">    String listenerUrl = server + <span class="string">&quot;/configs/listener&quot;</span>;</span><br><span class="line">    log.debug(<span class="string">&quot;request listener configs: [&#123;&#125;]&quot;</span>, listenerUrl);</span><br><span class="line">    JsonArray groupJson = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String json = <span class="keyword">this</span>.httpClient.postForEntity(listenerUrl, httpEntity, String.class).getBody();</span><br><span class="line">        log.debug(<span class="string">&quot;listener result: [&#123;&#125;]&quot;</span>, json);</span><br><span class="line">        groupJson = GSON.fromJson(json, JsonObject.class).getAsJsonArray(<span class="string">&quot;data&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RestClientException e) &#123;</span><br><span class="line">        String message = String.format(<span class="string">&quot;listener configs fail, server:[%s], %s&quot;</span>, server, e.getMessage());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SoulException(message, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (groupJson != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// fetch group configuration async.</span></span><br><span class="line">        ConfigGroupEnum[] changedGroups = GSON.fromJson(groupJson, ConfigGroupEnum[].class);</span><br><span class="line">        <span class="keyword">if</span> (ArrayUtils.isNotEmpty(changedGroups)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Group config changed: &#123;&#125;&quot;</span>, Arrays.toString(changedGroups));</span><br><span class="line">            <span class="keyword">this</span>.doFetchGroupConfig(server, changedGroups);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>网关的主动拉取数据和监听具体到了admin这边是由HttpLongPollingDataChangedListener负责。</p>
<p>拉取数据由fetchConfig方法处理，具体作用就是直接从缓存中根据组来获取数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ConfigData&lt;?&gt; fetchConfig(<span class="keyword">final</span> ConfigGroupEnum groupKey) &#123;</span><br><span class="line">    ConfigDataCache config = CACHE.get(groupKey.name());</span><br><span class="line">    <span class="keyword">switch</span> (groupKey) &#123;</span><br><span class="line">        <span class="keyword">case</span> APP_AUTH:</span><br><span class="line">            List&lt;AppAuthData&gt; appAuthList = GsonUtils.getGson().fromJson(config.getJson(), <span class="keyword">new</span> TypeToken&lt;List&lt;AppAuthData&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), appAuthList);</span><br><span class="line">        <span class="keyword">case</span> PLUGIN:</span><br><span class="line">            List&lt;PluginData&gt; pluginList = GsonUtils.getGson().fromJson(config.getJson(), <span class="keyword">new</span> TypeToken&lt;List&lt;PluginData&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), pluginList);</span><br><span class="line">        <span class="keyword">case</span> RULE:</span><br><span class="line">            List&lt;RuleData&gt; ruleList = GsonUtils.getGson().fromJson(config.getJson(), <span class="keyword">new</span> TypeToken&lt;List&lt;RuleData&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), ruleList);</span><br><span class="line">        <span class="keyword">case</span> SELECTOR:</span><br><span class="line">            List&lt;SelectorData&gt; selectorList = GsonUtils.getGson().fromJson(config.getJson(), <span class="keyword">new</span> TypeToken&lt;List&lt;SelectorData&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), selectorList);</span><br><span class="line">        <span class="keyword">case</span> META_DATA:</span><br><span class="line">            List&lt;MetaData&gt; metaList = GsonUtils.getGson().fromJson(config.getJson(), <span class="keyword">new</span> TypeToken&lt;List&lt;MetaData&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ConfigData&lt;&gt;(config.getMd5(), config.getLastModifyTime(), metaList);</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unexpected groupKey: &quot;</span> + groupKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而长轮询监听则是由doLongPolling负责。如果当前数据已经有变化则马上响应，而如果没有变化则将长轮询请求任务 <code>LongPollingClient</code> 扔到 <code>BlocingQueue</code> 中，并且开启调度任务，60s 后执行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doLongPolling</span><span class="params">(<span class="keyword">final</span> HttpServletRequest request, <span class="keyword">final</span> HttpServletResponse response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// compare group md5</span></span><br><span class="line">       List&lt;ConfigGroupEnum&gt; changedGroup = compareChangedGroup(request);</span><br><span class="line">       String clientIp = getRemoteIp(request);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// response immediately.</span></span><br><span class="line">       <span class="keyword">if</span> (CollectionUtils.isNotEmpty(changedGroup)) &#123;</span><br><span class="line">           <span class="keyword">this</span>.generateResponse(response, changedGroup);</span><br><span class="line">           log.info(<span class="string">&quot;send response with the changed group, ip=&#123;&#125;, group=&#123;&#125;&quot;</span>, clientIp, changedGroup);</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// listen for configuration changed.</span></span><br><span class="line">       <span class="keyword">final</span> AsyncContext asyncContext = request.startAsync();</span><br><span class="line"></span><br><span class="line">       <span class="comment">// AsyncContext.settimeout() does not timeout properly, so you have to control it yourself</span></span><br><span class="line">       asyncContext.setTimeout(<span class="number">0L</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">// block client&#x27;s thread.</span></span><br><span class="line">       scheduler.execute(<span class="keyword">new</span> LongPollingClient(asyncContext, clientIp, HttpConstants.SERVER_MAX_HOLD_TIMEOUT));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> class LongPollingClient implements Runnable &#123;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            this.asyncTimeoutFuture &#x3D; scheduler.schedule(() -&gt; &#123;</span><br><span class="line">                clients.remove(LongPollingClient.this);</span><br><span class="line">                List&lt;ConfigGroupEnum&gt; changedGroups &#x3D; compareChangedGroup((HttpServletRequest) asyncContext.getRequest());</span><br><span class="line">                sendResponse(changedGroups);</span><br><span class="line">            &#125;, timeoutTime, TimeUnit.MILLISECONDS);</span><br><span class="line">            clients.add(this);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-http-sync-data/" data-id="ckn5dfeo30006qkvngigmbk81" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-soul-http-run" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/04/06/soul-http-run/" class="article-date">
  <time class="dt-published" datetime="2021-04-06T01:53:29.050Z" itemprop="datePublished">2021-04-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li>fork soul仓库<a target="_blank" rel="noopener" href="https://github.com/dromara/soul">https://github.com/dromara/soul</a></li>
<li>导入idea后直接打包安装，可跳过文档和测试用例</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package install -Dmaven.test.skip=<span class="literal">true</span> -Dmaven.javadoc.skip=<span class="literal">true</span> -Drat.skip=<span class="literal">true</span> -Dcheckstyle.skip=<span class="literal">true</span></span><br></pre></td></tr></table></figure>

<ul>
<li>启动网关soul-boostrap，运行SoulAdminBootstrap后可打开<a target="_blank" rel="noopener" href="http://localhost:9095/%E8%BF%9B%E8%A1%8C%E7%AE%A1%E7%90%86">http://localhost:9095/进行管理</a></li>
</ul>
<p><img src="assets/20210114235037-q1zyi31-%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20210114235019.png" alt="微信截图20210114235019.png"></p>
<ul>
<li><p>启动管理端soul-admin，运行SoulAdminBootstrap</p>
</li>
<li><p>导入soul-example,运行soul-examples-http里的SoulTestHttpApplication</p>
</li>
<li><p>测试通过网关访问soul-examples-http的接口</p>
</li>
</ul>
<p><img src="assets/20210114234931-s23j5eq-test.png" alt="test.png"></p>
<ul>
<li>至此，基于http方式来使用soul网关就已经正常使用了。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/04/06/soul-http-run/" data-id="ckn5dfeo40007qkvnbicb4oms" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/04/">April 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/04/06/soul-http-client-register/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/04/06/soul-global-plugin/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/04/06/soul-dubbo-run/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/04/06/soul-dubbo-plugin/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/04/06/soul-divide-plugin/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>